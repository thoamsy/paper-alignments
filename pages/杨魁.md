# é¢å‘å°è§„æ¨¡é‡çš„å…¨æ–‡æœç´¢å¼•æ“çš„è®¾è®¡å’Œå®ç°

# æ‘˜è¦

æ—¶ä»£é£é€Ÿå‘å±•, æŠ€æœ¯æ—¥æ–°æœˆå¼‚, å¯¹å¼€å‘è€…çš„è¦æ±‚ä¹Ÿè¶Šæ¥è¶Šé«˜. å½“å¹´çš„â€œåˆ‡å›¾ä»”â€æ¼”å˜æˆç°åœ¨çš„**å…¨æ ˆå·¥ç¨‹å¸ˆ, å¤§å‰ç«¯**å°±æ˜¯å‰ç«¯å·¥ç¨‹å¸ˆçš„å‘å±•å†™ç…§.
æ›¾ç»è®¤ä¸ºå¥³ç”Ÿæ‰åº”è¯¥å»å†™å‰ç«¯çš„, å‰ç«¯å°±æ˜¯å†™å†™ç•Œé¢çš„äºº, åœ¨ç›®å‰çœ‹æ¥å¯ä»¥è¯´æ˜¯é”™çš„ç¦»è°±.
æœ€åŸºæœ¬çš„å‰ç«¯å·¥ç¨‹å¸ˆéœ€è¦äº†è§£çš„çŸ¥è¯†ä½“ç³»ç”šè‡³æ¯”åç«¯è¿˜å¤æ‚. æ¯ä¸€ä¸ªå‰ç«¯å·¥ç¨‹å¸ˆéƒ½éœ€è¦ä¼šå†™æœåŠ¡å™¨ä»£ç , æ¯ä¸€ä¸ªå‰ç«¯å·¥ç¨‹å¸ˆéƒ½éœ€è¦ä¼šå†™åŸç”Ÿåº”ç”¨.

å¥½åœ¨ JavaScript ç¡®å®èµ‹äºˆäº†ä»–ä»¬è¿™ç§èƒ½åŠ›. Nodejs æ˜¯è®©å‰ç«¯å¼€å‘è€…æŠ¬èµ·å¤´, åç«¯å¼€å‘è€…å­¦ä¹ å‰ç«¯çš„ä¸€ä¸ªè·¨æ—¶ä»£çš„å¹³å°. React Native çš„å‡ºç°è®© JavaScript ä¹Ÿèƒ½å†™ iOS å’Œ Android åº”ç”¨. Electron æ›´æ˜¯è®© JavaScript å¯ä»¥æ”»å æ¡Œé¢çº§çš„åº”ç”¨. æœ¬è®ºæ–‡ç¼–å†™çš„æ‰€æœ‰ä»£ç éƒ½æ˜¯ç”±ä¸€ä¸ªåŸºäº JavaScript æ­å»ºçš„ç¼–è¾‘å™¨å®Œæˆ.

å¯ä»¥è¯´, JavaScript çš„ç”Ÿæ€å·²ç»åŠ¿ä¸å¯æŒ¡äº†. æ‰€ä»¥æœ¬è®ºæ–‡ä¹Ÿé€šè¿‡æ­ä¸Šè¿™æœ¬å¿«è½¦, ä½¿ç”¨ Js æ¥æŠ•å»ºä¸€ä¸ªç®€æ˜“çš„æœç´¢å¼•æ“, æ¥æ¢ç´¢**å…¨æ ˆçš„å¯èƒ½æ€§**. å…¶ä¸­å‰ç«¯é‡‡ç”¨çš„æ˜¯ React, åç«¯åŸºäº Nodejs æ­å»º.

è¯¥æœç´¢å¼•æ“ä¼šçˆ¬å– Stack Overflow çš„ä¸€äº›å†…å®¹, å°è¯•åœ¨è¾“å…¥å…³é”®å­—å, èƒ½å¤Ÿå°†æœ¬ç«™çš„ç›¸å…³ç½‘é¡µæ˜¾ç¤ºå‡ºæ¥. æ’åçš„æ–¹å¼ä¸»è¦åŸºäºå…¶ä»–ç½‘é¡µç´¢å¼•è¯¥ç½‘ç«™çš„æ¬¡æ•°.

å…³é”®å­—: React; Koa; Nodejs; Search Engine; Python;



# Abstract

With the rapid development of the era, technology is changing with each passing day, and the requirements for developers are also getting higher and higher. The â€œfront-end engineersâ€ of the entire â€œstackâ€ engineer nowadays are the development portrayal of front-end engineers.
Those who think that girls should write front-ends, front-end writers and writers seem to be wrong at the moment.
The basic knowledge that front-end engineers need to understand is even more complex than the back end. Every front-end engineer needs to write server code. Every front-end engineer needs to write native applications.

Fortunately, JavaScript really gives them this ability. Nodejs is a cross-generational platform for front-end developers to look up and front-end developers learn about the front-end. The emergence of React Native makes it possible for JavaScript to write iOS and Android applications. Electron is Let JavaScript take over desktop-level applications. All the code written in this paper is done by a JavaScript-based editor.

It can be said that the ecology of JavaScript has become overwhelming. Therefore, this paper also hopes to use JS to build a simple search engine to explore the possibility of a full stack. The front end uses React, backend built by Nodejs.

The search engine crawls some of Stack Overflow's content and tries to display the site's related webpage after entering the keyword. The ranking method is mainly based on the number of times other websites index the website.

Keyword: React; Koa; Nodejs; Search Engine; Python;

# ç»ªè®º

## å‘å±•æ„ä¹‰å’ŒèƒŒæ™¯

éšç€æ—¶ä»£çš„ä¸æ–­æ¼”è¿›, äººä»¬å¯¹äºäº’è”ç½‘çš„ä¾èµ–ç¨‹åº¦, ä»¥åŠå¯¹**ç”¨æˆ·ä½“éªŒ**è¦æ±‚æå‡, å¼€å‘äººå‘˜é¢ä¸´çš„æŒ‘æˆ˜ä¹Ÿè¶Šæ¥è¶Šå¤š. çŸ¥è¯†å’ŒæŠ€æœ¯å·²ç»å­¦ä¸è¿‡æ¥, æ›´æ–°é€Ÿåº¦éå¸¸ä¹‹å¿«. ä¸€ä½ä½œè€…å¯èƒ½åˆšå°†ä¸€æœ¬æŠ€æœ¯ä¹¦å†™å®Œ, è¯¥æŠ€æœ¯å°±æ›´æ–°äº†æ–°ç‰ˆæœ¬, å¸¦æ¥äº†**ç ´åæ€§æ”¹å˜**, ä¸€å¤œä¹‹é—´è¿™æœ¬ä¹¦ä¼¼ä¹å°±è¿‡æ—¶äº†. ä¸ºäº†æ›´å¿«é€Ÿçš„å­¦ä¹ çŸ¥è¯†, æœç´¢å¼•æ“å¯¹äºå¼€å‘äººå‘˜æ¥è¯´æ˜¯ä¸å¯æˆ–ç¼ºçš„. é¢å‘ Google ç¼–ç¨‹, é¢å‘ Stack Overflow ç¼–ç¨‹æ˜¯ä¸€ç§è¶‹åŠ¿. å¦‚æœæ²¡æœ‰ Google, å¼€å‘äººå‘˜å¾ˆéš¾æ‰¾åˆ°è§£å†³æ–¹æ¡ˆ. Stack Overflow é‡Œå¦‚æœä¸èƒ½æœç´¢, è¿™ä¸ªç½‘ç«™ä¹Ÿæ²¡æœ‰å­˜åœ¨çš„æ„ä¹‰.
æ‰€ä»¥, å°è¯•è‡ªå·±å»æ­å»ºä¸€ä¸ªæœç´¢å¼•æ“, æ˜¯ååˆ†å¿…è¦çš„. å†ä¹Ÿä¸ç”¨æƒŠå¹äºæœç´¢çš„ç¥å¥‡, æ‹‰è¿‘å’Œåç«¯å·¥ç¨‹å¸ˆä»¬çš„è·ç¦».

## å‘å±•è¶‹åŠ¿

å›½å†…: å›½å†…çš„æœç´¢å¼•æ“ä»¥ç™¾åº¦æœ€ä¸ºé—»å. ä½†æ˜¯å› ä¸ºè¿‡äºå•†ä¸šåŒ–, ä»¥åŠå¯¹æŠ€æœ¯äººå‘˜çš„ä¸å‹å¥½, åŸºæœ¬ä¸Šå°±å’Œ Siri ä¸€æ ·, æ€»æ˜¯ç­”éæ‰€é—®. åœ¨å›½å†…ä¸€èˆ¬æ˜¯ä½œä¸ºä¸èƒ½ç§‘å­¦ä¸Šç½‘çš„å¤‡ç”¨é€‰æ‹©. è€Œå…¶ä»–çš„æœç´¢å¼•æ“, æ¯”å¦‚æŸæ•°å­—å…¬å¸å’ŒæŸåŠ¨ç‰©å…¬å¸çš„æœ‰ä¸€å®šçš„å¸‚åœºä»½é¢, ä½†åŸºæœ¬æ²¡æœ‰å°è¯•çš„å¿…è¦

å›½å¤–: å›½å¤–çš„è‘—åçš„æœç´¢å¼•æ“æœ‰: **Google, Bing, Yahoo, DuckDuckGo**. Google å’Œ DuckDuckGo çš„è‹±æ–‡æœç´¢ä½“éªŒç›¸å½“, éƒ½èƒ½ç»™å‡ºæƒ³è¦çš„æ•ˆæœ, éƒ½æ”¯æŒè‡ªåŠ¨ç¿»è¯‘å’Œé”™åˆ«å­—çŸ«æ­£åŠŸèƒ½.
ä½†æ˜¯è¿‘å¹´æ¥, éšç€ Google å‘äººå·¥æ™ºèƒ½çš„å‘åŠ›, æˆ‘ä»¬ç”¨ Google æœç´¢çš„ä»»ä½•å†…å®¹éƒ½ä¼šè¢«åˆ†æ, å¹¶ç”Ÿæˆä¸€ä¸ªç”¨æˆ·çš„ç‰¹å¾æ¨¡å‹, ä»¥èƒ½å¤Ÿæ¨é€æ›´åŠ å‡†ç¡®çš„ä¿¡æ¯æµ. ä¹Ÿå°±æ˜¯è¯´ç°åœ¨ Google ä¸ä»…ä»…æ˜¯ä¸€ä¸ªæœç´¢å¼•æ“, è€Œæ˜¯ä¸€å¥—ä¿¡æ¯æœåŠ¡. 

æœ¬è®ºæ–‡æ˜¾ç„¶ä¸ä¼šä»¥æ¨¡ä»¿ Google ç”šè‡³è¶…è¶Š Google çš„æŸä¸€æ–¹é¢ä½ç›®æ ‡, å®ƒæœ€å¤§çš„åŠŸåŠ³æ˜¯ååŠ©è¿™ç¯‡è®ºæ–‡çš„é¢ä¸–.

## ç³»ç»Ÿå¼€å‘ç›®æ ‡

å‰ç«¯é‡‡ç”¨ React æ„å»º, React å’Œä¼ ç»Ÿ MVC æ¨¡å¼çš„æ¡†æ¶ä¸åŒ, é‡‡ç”¨çš„æ˜¯ä¸€ç§å£°æ˜å¼çš„ç¼–ç¨‹æ–¹å¼. å°†**å‡½æ•°å¼ç¼–ç¨‹çš„æ€æƒ³æ¸—é€å…¶ä¸­**. åç«¯é‡‡ç”¨çš„ Koa æ˜¯ä¸€ä¸ªæ¯”è¾ƒæ–°çš„ Nodejs æ¡†æ¶. å®ƒå……åˆ†æ‹¥æŠ±äº† `async await` æ¨¡å¼, è®©å¼€å‘è€…ä» Nodejs çš„ `callback hell` ä¸­è§£è„±å‡ºæ¥, ä½¿ç”¨æ›´ä¸ºç°ä»£çš„æ–¹å¼ç¼–ç¨‹.
æœç´¢å¼•æ“çš„ç›®æ ‡æ˜¯åœ¨ç¡®å®šæœç´¢å, é¡ºåºçš„å“åº”çš„ç”¨æˆ·çš„æœç´¢å†…å®¹, å¹¶ç»™å‡ºä¸€ä¸ªæ‹¥æœ‰åˆç†æ’åºçš„æœç´¢å†…å®¹.

# åŸºæœ¬èƒŒæ™¯çŸ¥è¯†

## HTTP åè®®

ä¸ºäº†æ›´å¥½çš„ç†è§£æœç´¢å¼•æ“çš„æœ¬è´¨å’ŒåŸç†, å…ˆæ¥ä¸€èµ·æ¢ç´¢ä¸‹å®ƒæ‰€ä¾èµ–çš„åè®®: **HTTP.**
HTTP æœ€æ–°ç‰ˆæœ¬æ˜¯ 2, ç›¸æ¯” 1.1 å¸¦æ¥é©å‘½æ€§çš„æå‡å’Œæ”¹å˜. ä¸è¿‡ä¸ºäº†æ–¹ä¾¿ç†è§£, æœ¬æ–‡è¿˜æ˜¯åŸºäº HTTP 1.1 æ¥è§£é‡Šæ•´ä¸ªæµç¨‹. å¦å¤–, HTTP åè®®ä»¥ä¸‹çš„åè®®æ ˆ, åªè§£é‡Šåˆ° TCP å±‚.

æ‹¿ Google ä¸¾ä¾‹, åœ¨æœç´¢æ¡†ä¸­è¾“å…¥æœç´¢å†…å®¹å, æŒ‰ä¸‹å›è½¦æˆ–è€… **Search** æŒ‰é’®, å¼€å§‹çš„ç¬¬ä¸€æ­¥å°±æ˜¯å°†è¾“å…¥çš„å†…å®¹ä¼ å…¥ä¸€ä¸ªå«åš **q** çš„å‚æ•°, ä»¥åŠå…¶ä»–ç»†èŠ‚å‚æ•°ä¸€èµ·ç»„è£…å¥½. åŠ ä¸Š HTTP è¯·æ±‚è¡Œ, HTTP é¦–éƒ¨. åŒ…è£…æˆä¸€ä¸ª **GET** è¯·æ±‚. ä¸ºäº†ç®€å•, è¿™é‡Œè¿˜æ˜¯å¿½ç•¥äº†å¾ˆå¤šç»†èŠ‚, æ¯”å¦‚ Google çš„æœç´¢å»ºè®®.

è¿™ä¸ªè¯·æ±‚å¯èƒ½é•¿è¿™æ ·:

```http
GET / HTTP/1.1
HOST: www.google.com.hk
Accept: */*
```

åŒ…è£…å¥½å, è¿˜éœ€è¦ä¸€ä¸ªä¼™è®¡å°†è¯¥è¯·æ±‚ä¼ é€åˆ° Google çš„ IP ä¸‹. å…³äºè·å– IP çš„æ–¹æ³•ä¸æ˜¯æœ¬æ–‡çš„é‡ç‚¹, åªè¦çŸ¥é“æ˜¯é€šè¿‡ **DNS** åè®®æ¥å®ç°çš„. ä¸€æ—¦è·å–åˆ° IP, è¿™ä¸ªä¼™è®¡å°±èƒ½å·¥ä½œäº†. æ¬¢è¿ **TCP**

TCP åè®®æœ€å¹¿ä¸ºäººçŸ¥çš„åœ°æ–¹å°±æ˜¯å®ƒçš„ä¸‰æ¬¡æ¡æ‰‹, ç®€å•å›é¡¾ä¸‹.

1. æµè§ˆå™¨å‘å‡ºä¸€æ®µ datagram ç»™ Google , é‡Œé¢åŒ…å«äº† SYN å­—æ®µ
2. Google æ”¶åˆ°è¯¥ datagram å, ä½œå‡ºå¤„ç†(æ¯”å¦‚åˆ†é…å†…å­˜), ä¹Ÿå‘å‡ºä¸€æ®µ datagram, åŒ…å«äº† SYN å’Œ ACK å­—æ®µ
3. æµè§ˆå™¨æ”¶åˆ° datagram, å°†ä¹‹å‰çš„ç”Ÿæˆçš„ HTTP è¯·æ±‚å’Œ ACK å­—æ®µä¸€èµ·å‘é€ç»™ Google

```sequence
Browser -> Google: SYN
Note right of Google: Google Server alloc socket and resource, and response
Google -> Browser: SYN ACK
Browser -> Google: ACK Body
```



ç»è¿‡è¿™äº›æ­¥éª¤, Google æœåŠ¡å™¨ç»ˆäºçŸ¥é“è¦æœç´¢ä»€ä¹ˆå†…å®¹, å¹¶åšäº†ä¸€ç•ªå¤„ç†, å°†ç»“æœè¿”å›ç»™äº†æµè§ˆå™¨. è¿™é‡Œçš„ä¸€ç•ªå¤„ç†å¯ä¸ç®€å•, ä¹Ÿæ˜¯æœ¬æ–‡çš„åŠªåŠ›ç›®æ ‡.

æµè§ˆå™¨è·å–åˆ°äº† Google çš„å“åº”, æ¯”å¦‚è¿™æ ·

```http
HTTP/1.1 200 OK
content-type: text/html
content-length: â€¦

â€¦â€¦â€¦â€¦
```

Google è¿”å›çš„ä»…ä»…æ˜¯ä¸€ä¸ª HTML æ–‡ä»¶. éšç€æµè§ˆå™¨å»è§£æè¯¥ HTML æ–‡ä»¶, æ¥ç€å°±ä¼šå°† HTML ä¸­çš„å…¶ä»–**å…³é”®è·¯å¾„ä¸Šçš„æ–‡ä»¶**è·å–. æ¯”å¦‚ CSS, JS æˆ–è€…å…¶ä»– SVG å›¾ç‰‡. æœ€åå°±èƒ½çœ‹åˆ°ç»“æœ.

## TLS

ä¸Šé¢å…¶å®é—æ¼äº†ä¸€äº›å†…å®¹. Google ç°åœ¨æ˜¯åŸºäº HTTPS çš„, ä¹Ÿå°±æ˜¯è¯´, åœ¨å‘é€ HTTP è¯·æ±‚ä¹‹å‰, è¿˜éœ€è¦å’Œ TLS åè®®è¿›è¡Œä¸€æ®µæ²Ÿé€š. ç›¸æ¯” TCP, è¿‡ç¨‹æ›´ä¸ºå¤æ‚.

1. æµè§ˆå™¨å‘é€ä¸€æ®µ _Client Hello_ ä¿¡æ¯ç»™ Google, å¹¶ä¸”å¸¦ä¸Šäº†ä¸€ä¸ªéšæœºæ•°å’Œæ”¯æŒçš„åŠ å¯†æ–¹æ³•(åå•†)
2. Google å›åº”äº†ä¸€æ®µ _Server Hello_ ä¿¡æ¯ç»™æµè§ˆå™¨, å¸¦ä¸Šäº†ä¸€ä¸ªéšæœºæ•°
3. åŒæ—¶ Google æŠŠå®ƒçš„è¯ä¹¦å‘é€ç»™æµè§ˆå™¨(åœ¨æŸäº›é‡‘èç½‘ç‚¹, è¿˜éœ€è¦æµè§ˆå™¨æä¾›è¯ä¹¦). è¿™æ˜¯ä¸€ä¸ª _Server Done_ ä¿¡æ¯
4. æµè§ˆå™¨ç¡®è®¤ Google çš„è¯ä¹¦æœ‰æ•ˆ, å°±ä¼šç”Ÿæˆç¬¬ä¸‰ä¸ªéšæœºæ•°, **Premaster secret**. ç”¨ Google çš„å…¬é’¥åŠ å¯†è¿™ä¸ªéšæœºæ•°å¹¶å‘é€ç»™ Google. å¦‚æœå‘ç°è¯ä¹¦æ— æ•ˆæˆ–è€…è¿‡æœŸäº†, æµè§ˆå™¨å°±ä¼šå‘å‡ºè­¦å‘Š, é˜»æ­¢ç”¨æˆ·è®¿é—®
5. Google ä½¿ç”¨è‡ªå·±çš„ç§é’¥è§£å¯†äº†è¿™ä¸ªæµè§ˆå™¨. è¿™ä¸ªæ—¶å€™, Google å’Œæµè§ˆå™¨éƒ½ä¼šä½¿ç”¨è¿™ä¸‰ä¸ªéšæœºæ•°ç”Ÿæˆçš„ä¸€ä¸ªä¼šè¯ç§˜é’¥ **session key** æ¥åŠ å¯†æ¥ä¸‹æ¥çš„ä¿¡æ¯
6. æµè§ˆå™¨ä¼šå‘é€ä¸€ä¸ª _Change cipher spec_ æ¥é€šçŸ¥ Google, æ¥ä¸‹æ¥æ‰€æœ‰çš„ä¿¡æ¯éƒ½è¦å¼€å§‹åŠ å¯†. åŒæ—¶å‘é€ _Client Finished_ ä¿¡æ¯
7. Google æ”¶åˆ°äº†è¯¥é€šçŸ¥, å¼€å§‹ä½¿ç”¨ä¼šè¯ç§˜é’¥. å¹¶å‘é€ _Server Finished_ ä¿¡æ¯
8. ç°åœ¨æµè§ˆå™¨å’Œ Google å·²ç»å»ºç«‹å¥½åŠ å¯†é€šé“, æ‰€æœ‰çš„æ¶ˆæ¯éƒ½ä¼šè¢«åŠ å¯†. æ¥ä¸‹æ¥çš„æ­¥éª¤å°±å›åˆ°äº†ä¸Šé¢çš„ TCP è¿‡ç¨‹

è¿™ä¸ªè¿‡ç¨‹ç¡®å®å¾ˆå¤æ‚, è‡³äºå…¬é’¥å’Œç§é’¥çš„ç”Ÿæˆç»†èŠ‚è¿™é‡Œå°±å¿½ç•¥, ä»¥ä¾¿å¸¦æ¥æ›´å¤šçš„å¤æ‚æ€§.
è™½ç„¶æœ¬æ–‡è·³è¿‡äº†ä¸€äº›æ­¥éª¤, ä½†æ˜¯ä¸»è¦çš„è¿‡ç¨‹å·²ç»æè¿°æ¸…æ¥š. å¯ä»¥çœ‹ä¸€å¼ å›¾æ¥å·©å›ºä¸€ä¸‹
![1_rjBdCBwOx5Gp_A6b6FQgfw](/Users/yk/Documents/paper/pages/1_rjBdCBwOx5Gp_A6b6FQgfw.png)

å›åˆ° Google è¿”å› HTML çš„åœ°æ–¹, æµè§ˆå™¨åˆ°åº•æ˜¯å¦‚ä½•ä½¿ç”¨ HTML, CSS, JavaScript åœ¨å±å¹•ä¸Šæ¸²æŸ“æ¼‚äº®çš„ç½‘é¡µå‘¢?

## å…³é”®æ¸²æŸ“è·¯å¾„

ä¸€ä¸ª HTML æ–‡ä»¶ä»åŠ è½½åˆ°æ˜¾ç¤ºå‡ºæ¥çš„è¿‡ç¨‹, è¢«ç§°ä¸º **å…³é”®æ¸²æŸ“è·¯å¾„**. ä¸€èˆ¬åˆ†ä¸º 4 ä¸ªæ­¥éª¤

1. DOM æ ‘æ„å»º
2. CSSOM æ„å»º
3. å¸ƒå±€(Layout)
4. ç»˜åˆ¶(Paint)
   æœ¬æ–‡æš‚ä¸”ä¸è®¨è®º JavaScript çš„é€»è¾‘. å› ä¸ºç°ä»£ JavaScript è¿‡äºå¤æ‚, è¿™æ–¹é¢æœ‰å¾ˆä¼˜ç§€çš„[ç´ æ](https://developers.google.cn/web/fundamentals/performance/critical-rendering-path/adding-interactivity-with-javascript)

### DOM æ ‘çš„æ„å»º

ä¸ºäº†ç®€åŒ–å¤æ‚æ€§, å…ˆå‡è®¾ HTML é‡Œä»…ä»…åŒ…å«ä¸€äº›ç®€å•çš„æ–‡æœ¬å’Œä¸€å¼ å›¾ç‰‡, åˆ™ DOM æ ‘çš„æ„å»ºè¿‡ç¨‹ä¸º

1. **è½¬æ¢:** æµè§ˆå™¨å…ˆè¯»åŒºç£ç›˜(ç¼“å­˜)æˆ–è€…ç½‘ç»œä¸­ HTML çš„åŸå§‹å­—èŠ‚, ä½¿ç”¨æ–‡ä»¶æŒ‡å®šçš„ç¼–ç æ–¹å¼(UTF-8), å°†å®ƒä»¬è½¬åŒ–æˆå­—ç¬¦
2. **Token åŒ–:** å°†å­—ç¬¦ä¸­æ‰€æœ‰ W3C æ ‡å‡†ä¸­è§„å®šçš„æ ‡ç­¾[^1]æ¢æˆç‰¹å®šçš„ Token
3. **è¯æ³•æ„å»º:** å°†æ‰€æœ‰ Token è½¬åŒ–æˆè§„åˆ™å¯¹è±¡
4. **DOM æ„å»º:** æ ¹æ®æ ‡ç­¾å’Œæ ‡ç­¾ä¹‹é—´çš„åŒ…å«å…³ç³»æ¥å»ºç«‹ DOM æ ‘

![DOM æ„å»º](/Users/yk/Documents/paper/pages/dom-tree.png)

æ•´ä¸ªæµç¨‹è¿˜å¯ä»¥ç”¨ä¸€å¼ å›¾æ¥è¡¨ç¤º
![æ•´ä¸ªæµç¨‹](/Users/yk/Documents/paper/pages/full-process.png)

### CSSOM æ„å»º

åœ¨æ„å»º DOM æ ‘çš„æ„æˆä¸­, ä¼šç¢°åˆ° `link` æ ‡ç­¾. å¦‚æœæ ‡ç­¾ä¸­å¼•ç”¨äº† css æ–‡ä»¶çš„è¯, æµè§ˆå™¨**ä¼˜å…ˆå»**æ„å»º CSSOM, å’Œè¿‡ç¨‹å’Œæ„å»º DOM æ ‘ç›¸ä¼¼.

### æ¸²æŸ“æ ‘

åœ¨ DOM å’Œ CSSOM éƒ½æ„å»ºå¥½å, æµè§ˆå™¨å°±ä¼šå°† DOM å’Œ CSSOM åˆå¹¶, ç”Ÿæˆæ–°çš„ **Render Tree**
ä¸ºäº†æ„å»ºå®ƒ, æµè§ˆå™¨åšäº†è¿™äº›æ­¥éª¤:

1. ä» DOM æ ‘æ ¹èŠ‚ç‚¹å¼€å§‹éå†ä¸å¯è§çš„èŠ‚ç‚¹: `meta, script`, ä¸ä¼šå‡ºç°åœ¨æ¸²æŸ“æ ‘ä¸­é€šè¿‡ CSS éšè—çš„èŠ‚ç‚¹: `display: none`, ä¹Ÿä¸ä¼šå‡ºç°åœ¨æ¸²æŸ“æ ‘ä¸­
2. å¯¹æ‰€æœ‰å¯è§çš„èŠ‚ç‚¹, åº”ç”¨ CSSOM çš„è§„åˆ™
3. ç”Ÿæˆæ¸²æŸ“æ ‘

![æ¸²æŸ“æ ‘](/Users/yk/Documents/paper/pages/render-tree-construction.png)

æ¥ç€æ ¹æ®æ¸²æŸ“æ ‘ä¸­çš„æ ·å¼ä¿¡æ¯, æµè§ˆå™¨è¿›å…¥ **Layout** é˜¶æ®µ. è¿™ä¸ªé˜¶æ®µæ˜¯ä¸ºäº†å¼„æ¸…æ¯ä¸ªå¯¹è±¡çš„ç¡®åˆ‡ä½ç½®å’Œå¤§å°. æœ€åæ ¹æ®ä½ç½®å’Œå¤§å°, æµè§ˆå™¨å°±èƒ½å°†å®ƒä»¬å†™å…¥å®é™…çš„åƒç´ ä¸­, è¿™é‡Œè¢«ç§°ä¸º **Paint**

ç»å†â€œç©·å±±æ¶æ°´â€, æµè§ˆå™¨ç»ˆäºæˆåŠŸæ¸²æŸ“äº†è¿™äº›æ–‡å­—å’Œå›¾ç‰‡.



# ç¼–å†™çˆ¬è™«

äº†è§£äº†åŸºæœ¬çš„æµè§ˆå™¨çš„è¿è¡Œæœºåˆ¶, ç°åœ¨å¯ä»¥è¿›å…¥åˆ°æ­£é¢˜. æœç´¢å¼•æ“çš„æ„å»º, åœ¨æœ¬æ–‡ä¸­, ä¸»è¦åˆ†ä¸ºä¸‰æ­¥:

1. æ„å»ºçˆ¬è™«
2. ä½¿ç”¨çˆ¬å–çš„æ•°æ®æ„å»ºç´¢å¼•
3. å¯»æ‰¾ä¸€ä¸ªåˆç†çš„ Rank ç®—æ³•

ä¸ºäº†æ–¹ä¾¿åæ–‡å¼•ç”¨, æœ¬æ–‡æ„å»ºçš„æœç´¢å¼•æ“ç”¨ YSE æ¥å–ä»£.
ä½œä¸ºä¸€ä¸ªå°å‹é¡¹ç›®, YSE ä¸å¯èƒ½ä¹Ÿä¸åº”è¯¥å°è¯•å»åƒå…¶ä»–æœç´¢å¼•æ“ä¸€æ ·, çˆ¬å–æ‰€æœ‰äº’è”ç½‘ä¸Šçš„é¡µé¢, åº”è¯¥å°†çˆ¬è™«æ”¾åœ¨æŸä¸ªç‰¹å®šçš„ç½‘ç«™ä¸‹é¢, YSE ä½¿ç”¨çš„æ˜¯ [Stack Overflow](https://stackoverflow.com) ä½œä¸º**ç§å­** , ä¹Ÿå°±æ˜¯çˆ¬è™«å¼€å§‹çš„ç¬¬ä¸€ä¸ªç•Œé¢.

## è·å–ä¸€ä¸ªç½‘é¡µä¸Šçš„è¶…é“¾æ¥

ä¸ºäº†æµ‹è¯•çˆ¬è™«çš„å¯è¡Œæ€§, å…ˆå°†ä»»åŠ¡ç®€åŒ–, ä»åªè·å–ä¸€ä¸ªç½‘é¡µçš„æ‰€æœ‰ **href** å¼€å§‹, ä¸åšä»»ä½•æ–‡æœ¬å¤„ç†. åœ¨è¿™é‡Œ href, æˆ–è€…è¯´ _Hyper Reference_, æŒ‡çš„æ˜¯ a æ ‡ç­¾çš„ href å±æ€§. æ¯”å¦‚, **img, css, JavaScript** è¿™äº›æ–‡ä»¶éƒ½ä¸æ˜¯çˆ¬è™«æ„Ÿå…´è¶£çš„å†…å®¹. æ ¹æ® [CSS Selector](https://www.w3schools.com/cssref/css_selectors.asp) è§„èŒƒ, ä½¿ç”¨ä¸€ä¸ªå¾ˆç®€å•çš„ CSS é€‰æ‹©å™¨å°±èƒ½å®ç° `a[href]`.

çˆ¬è™«æ˜¯åŸºäºæœåŠ¡å™¨å»ºç«‹çš„, CSS é€‰æ‹©å™¨å±äº W3C æ ‡å‡†, è¿™ä¸ªä¼¼ä¹åº”è¯¥åªèƒ½åœ¨æµè§ˆå™¨ä¸­å­˜åœ¨, æ€ä¹ˆè¿ç”¨åœ¨åç«¯å‘¢? è¿™é‡Œéœ€è¦æ¾„æ¸…ä¸‹, **æ ‡å‡†æ˜¯æ ‡å‡†, å®ç°æ˜¯å®ç°. å®ç°å¯ä»¥å‚è€ƒæ ‡å‡†, å¹¶åœ¨ä»»ä½•å¹³å°å®ç°**. æ‰€ä»¥è¯´, æµè§ˆå™¨ä¸Šçš„ CSS é€‰æ‹©å™¨æ˜¯æµè§ˆå™¨çš„å®ç°, åç«¯å½“ç„¶ä¹Ÿæœ‰åç«¯çš„å®ç°, æ¯”å¦‚æœ¬æ–‡å°†è¦é‡‡ç”¨åˆ°çš„ [cheerio](http://cheerio.js.org), å°±æ˜¯ Nodejs çš„ä¸€ç§**å®ç°**

é€šè¿‡åŒ…ç®¡ç†å·¥å…·ä¸‹è½½å¥½ cheerio å, è¾“å…¥
`import cheerio from 'cheerio'`
å°±èƒ½å¼€ç®±ä½¿ç”¨äº†. è€Œæƒ³è¦è·å–ä¸€ä¸ªç½‘é¡µçš„æ‰€æœ‰ href å†…å®¹çš„è¯, å¯ä»¥å†™æˆ

```js
const text = 'â€¦â€¦â€¦'; // text å˜é‡æ˜¯ä¸€é•¿ä¸²æ–‡æœ¬
const $ = cheerio(text);

const allLinks = $('a[href]').map((_, element) => $(element).attr('href'))).get()
```

é€šè¿‡è¿™ç§æ–¹å¼, å°±èƒ½è·å¾— text æ‰€ä»£è¡¨çš„ HTML ä¸­æ‰€æœ‰çš„ href. ä½†åœ¨çœŸæ­£ä¸­çš„çˆ¬è™«ä¸­, ä¼ å…¥çš„å‚æ•°åº”è¯¥æ˜¯ URL, è€Œä¸æ˜¯æ•´ä¸ª HTML æ–‡ä»¶. æ¯•ç«Ÿä¸€ä¸ªçˆ¬è™«, åº”è¯¥åªéœ€è¦å…³æ³¨ç§å­ç½‘é¡µå°±è¡Œäº†.

```js
const url = 'https://www.google.com';
const getPage = async url => {
  try {
    const html = await fetch(url).then(res => res.text());
    return cheerio.load(html);
  } catch (err) {
    console.log(err);
  }
};
const $ = getPage(url);
```

Fetch URL çš„æ“ä½œ, å°±ç”±ç¬¬å››è¡Œ, ä¹Ÿå°±æ˜¯å«æœ‰ `fetch` çš„é‚£ä¸€è¡Œå®Œæˆäº†è¿™ä¸ªä»»åŠ¡.
è¿™æ ·çš„è¯, è·å–æ‰€æœ‰é“¾æ¥çš„ä»»åŠ¡å°±å’Œä¹‹å‰çš„ä»£ç ä¸€æ ·, å› ä¸ºæ­¤æ—¶çš„ `$` å·²ç»è·å¾—äº† URL çš„ HTML.

è¿™æ®µä»£ç çœ‹ä¸Šå»æ²¡æœ‰ä»»ä½•é—®é¢˜, ä¸è¿‡, è¿˜æœ‰ä¸€ä¸ªéšè—çš„é—®é¢˜éœ€è¦æŒ‡å‡ºæ¥.
`fetch` åªèƒ½æ”¯æŒ**ç»å¯¹è·¯å¾„**çš„ URL!
è¿™å¾ˆå®¹æ˜“ç†è§£, ç»™ä¸€ä¸ª \_.\_abc.html/ è¿™ç§é“¾æ¥, è¿™åº”è¯¥è¢«è®¤ä¸ºæ˜¯è¯»å–æœ¬æœºæ–‡ä»¶çš„æ“ä½œ, ä¸å…¶ç”¨ fetch ä¸å¦‚ä½¿ç”¨ `readFile`.
ä½†æ˜¯ä»€ä¹ˆæ—¶å€™ä¼šç¢°åˆ°ç›¸å¯¹è·¯å¾„çš„æƒ…å†µå‘¢?? ä¹ä¸€çœ‹å¾ˆéš¾ç†è§£, å› ä¸ºæˆ‘ä»¬å¯ä»¥æ§åˆ¶ç§å­ç½‘é¡µçš„å†…å®¹, **ä¸å¯èƒ½ä¼šä¼ ä¸€ä¸ªç›¸å¯¹è·¯å¾„çš„ URL è¿›å»**. å¯æ˜¯ä¸èƒ½ä¿è¯ a æ ‡ç­¾ä¸­çš„ href ä¸æ˜¯ç›¸å¯¹è·¯å¾„!
è¿™ä¸ªé—®é¢˜æœ‰ä¸¤ç§æ–¹æ³•æ¥è§£å†³, ç¬¬ä¸€ç§æ˜¯è¿‡æ»¤æ‰€æœ‰çš„ç›¸å¯¹è·¯å¾„, ç¬¬äºŒç§åˆ™æ˜¯å°†ç›¸å¯¹è·¯å¾„è½¬åŒ–æˆç»å¯¹è·¯å¾„. ç¬¬ä¸€ç§å®ç°ç®€å•, åªéœ€è¦æ”¹ä¸€ä¸‹é€‰æ‹©å™¨, æ”¹ä¸º `a[href^=http]` å°±è§£å†³é—®é¢˜äº†. è¿™ä¸ªé€‰æ‹©å™¨çš„æ„æ€å°±æ˜¯**ç­›é€‰æ‰€æœ‰ href å±æ€§ç”± http å¼€å¤´çš„ a æ ‡ç­¾**, è¿™æ ·å°±èƒ½ä¿è¯å¾—åˆ°çš„è·¯å¾„éƒ½æ˜¯ç»å¯¹è·¯å¾„.
ä»å¼€å‘äººå‘˜çš„è§’åº¦, ç›¸å¯¹è·¯å¾„æ¯”ç»å¯¹è·¯å¾„å¥½å†™å¤šäº†. æ‰€æœ‰ä¸€ä¸ªç½‘ç«™ä¸­, æ›´å¤šçš„å¯èƒ½ä½¿ç”¨çš„è¿˜æ˜¯ç›¸å¯¹è·¯å¾„, è¿™ç§è‡ªæŸä¸‰åƒçš„æ–¹æ³•, æ¥ä¸‹æ¥ä¼šæ”¹è¿›.

## æ”¾å‡ºçˆ¬è™«

ç°åœ¨å·²ç»çŸ¥é“å¦‚ä½•è·å¾—ä¸€ä¸ªç½‘é¡µä¸­æ‰€æœ‰çš„ href, å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„ä»£ç æ¥çœ‹çœ‹æ•ˆæœ

```js
console.log(allLinks(getPage('https://stackoverflow.com')));
```

ä¸å‡ºæ„å¤–çš„è¯, ä¼šè¾“å‡ºç±»ä¼¼äºè¿™æ ·çš„ç»“æœ.

![è¾“å‡ºç»“æœ](/Users/yk/Documents/paper/pages/image-20180422232927864.png)

æ¥ä¸‹æ¥å¯ä»¥å°†çˆ¬å–åˆ°çš„æ‰€æœ‰ç½‘é¡µå†…å®¹, åŠ å…¥æ•°ç»„, é€’å½’æ‰§è¡Œçˆ¬å–æ­¥éª¤.
æ—¢ç„¶æ˜¯é€’å½’, å°±éœ€è¦æœ‰ä¸€ä¸ªé€’å½’çš„ç»ˆæ­¢æ¡ä»¶. è¿™é‡Œçš„ç»ˆæ­¢æ¡ä»¶å°±æ˜¯æ•°ç»„ä¸ºç©ºä¸ºæ­¢.

ä¸è¿‡ä¼šå¼•å‘ä¸€ä¸ªé—®é¢˜, æ•°ç»„ä¸€å®šä¼šä¸ºç©ºå—? ç­”æ¡ˆæ˜¯å¾ˆå¯èƒ½ä¸ä¼š
åŸå› æœ‰å‡ ç‚¹:

1. å­˜åœ¨å¤–é“¾
2. é“¾æ¥ä¹‹é—´ä¼šç›¸äº’å¼•ç”¨
3. é“¾æ¥å¤ªå¤š

æœ€åä¸€ä¸ªå¾ˆå®¹æ˜“ç†è§£, å¦‚æœé“¾æ¥å¤ªå¤šçš„è¯, é‚£ä¹ˆæƒ³è¦åœ¨ç›¸å¯¹çŸ­çš„æ—¶é—´å†…çˆ¬å–æ‰€æœ‰ç½‘é¡µæ˜¾ç„¶æ˜¯ä¸å¯èƒ½çš„. ä¸€ä¸ªå¯è¡Œçš„æ–¹æ³•æ˜¯è§„å®šçˆ¬å–æ¬¡æ•°å¦åˆ™çˆ¬å–æ—¶é—´. æ¯”å¦‚çˆ¬å– 10000 ä¸ªæˆ–è€…è¿è¡Œååˆ†é’Ÿååœæ­¢.
å‰é¢çš„ä¸¤ä¸ªåŸå› , ä¹Ÿèƒ½å¾ˆå¥½çš„è§£å†³. ç¬¬ä¸€ä¸ªé—®é¢˜æˆ‘ä»¬åªè¦å¯¹çˆ¬å–åˆ°çš„é“¾æ¥è¿›è¡Œä¸€æ¬¡ç­›é€‰, å°†ä¸»æœºä¸æ˜¯ Stack Overflow çš„åŸŸåå»æ‰. è€Œç¬¬äºŒä¸ªå¾ªç¯é“¾æ¥çš„é—®é¢˜, å¯ä»¥é€šè¿‡ä¿å­˜æ‰€æœ‰è®¿é—®è¿‡çš„é“¾æ¥, å¹¶ä¸”åªè®¿é—®æ²¡æœ‰è®¿é—®è¿‡å¾—é“¾æ¥æ¥è§£å†³.
å…¶å®å¾ªç¯é“¾æ¥çš„é—®é¢˜å’Œå¹¿åº¦ä¼˜å…ˆæœç´¢çš„è§£å†³æ–¹æ³•å¾ˆç›¸ä¼¼. æ²¡é”™, çˆ¬è™«ä½¿ç”¨çš„å°±æ˜¯å¹¿åº¦ä¼˜å…ˆçš„ç­–ç•¥. ä¸ºä»€ä¹ˆä¸ç”¨æ·±åº¦ä¼˜å…ˆå‘¢? å› ä¸ºè¿™å¾ˆå®¹æ˜“å¯¼è‡´æ ˆæº¢å‡ºâ€¦

é€šè¿‡ä¸Šé¢çš„åˆ†æ, çˆ¬è™«ç»ˆäºå¯ä»¥æ´¾ä¸Šç”¨åœºäº†.

```js
const crawlWeb = async seed => {
  let tocrawl = [seed];
  const crawled = {};

  while (tocrawl.length) {
    const page = tocrawl.pop();
    if (!crawled[page]) {
      const $ = await getPage(page);
      const outlinks = getAllLinks($);
      tocrawl = union(tocrawl, outlinks).filter(link => {
        return new URL(link).hostname.includes('stackoverflow');
      });
      crawled[page] = true;
    }
  }
};
```

æ¥ä¸‹æ¥è¦è§£å†³ä¹‹å‰é—ç•™çš„é—®é¢˜: **å¤„ç†ç›¸å¯¹è·¯å¾„**. Nodejs çš„ URL æ–¹æ³•åªèƒ½è½¬æ¢ç»å¯¹è·¯å¾„, å¦åˆ™å°±ä¼šæŠ›å‡ºå¼‚å¸¸.
æ¯”å¦‚ `new URL('./abc')` è¿™æ ·å°±ä¼šæŠ¥é”™. äºæ˜¯å¯ä»¥åˆ©ç”¨å®ƒçš„æŠ¥é”™, é…åˆ `try catch` æ¥å°†ç›¸å¯¹è·¯å¾„è½¬åŒ–æˆç»å¯¹è·¯å¾„. å›åˆ°ä¹‹å‰ `getAllLinks`

```js
const getAllLinks = ($, page) => {
  const { origin } = new URL(page);
  return $('a[href]')
    .map((_, element) => {
      const href = $(element).attr('href');
      try {
        new URL(href);
      } catch (err) {
        return href[0] === '/' ? `${origin}${href}` : `${origin}/${href}`
      }
      return href;
    })
    .get();
};
```

`getAllLinks` å’Œä¹‹å‰ç›¸æ¯”å¤šäº†ä¸€å‚æ•°â€”page, å®ƒç”¨æ¥ä¿å­˜æ­£åœ¨çˆ¬å–çš„ç½‘é¡µçš„ä¿¡æ¯. å¯ä»¥é€šè¿‡å®ƒäº†è§£åˆ°å½“å‰ç½‘ç«™çš„ hostname å’Œ origin, å†æ·»åŠ åˆ°ç›¸å¯¹è·¯å¾„ä¹‹å‰å°±å¯ä»¥å¾—åˆ°ç»å¯¹è·¯å¾„.

### é™åˆ¶æœç´¢æ·±åº¦å’Œé•¿åº¦

å› ä¸ºç°å®çš„å¤æ‚æ€§, è¿˜æ˜¯ä¸èƒ½ç›²ç›®çš„å‡è®¾çˆ¬è™«æœ€ç»ˆä¼šåœä¸‹æ¥, æ‰€ä»¥è¿˜æ˜¯è¦é™åˆ¶ä¸‹çˆ¬è™«çš„æœç´¢æ·±åº¦å’Œé•¿åº¦æœç´¢çš„é•¿åº¦å¾ˆå®¹æ˜“é™åˆ¶, å›å¿†è¿™ä¸ªä»£ç  `while (tocrawl.length)`

é™¤äº†æ¯æ¬¡æ£€æŸ¥æ•°ç»„çš„æ˜¯å¦ä¸ºç©ºå¤–, ä¹Ÿè¦æ£€æŸ¥å½“å‰æ•°ç»„çš„é•¿åº¦, å¦‚æœè¶…è¿‡äº†ä¸€ä¸ªé™åˆ¶å€¼, ä¹Ÿä¼šçš„ç»“æŸçˆ¬å–. æ”¹æˆ `while (tocrawl.length && len(tocrawl) < maxLength)` . åŒæ ·çš„æœç´¢æ·±åº¦ä¹Ÿå¯ä»¥åšåˆ°é™åˆ¶. 

```mermaid
graph LR
A[a] -->B(b)
    B --> E[e]
    	E-->|è¶…è¿‡æœ€å¤§æ·±åº¦| I[i]
    B --> F[f]
    B --> M[m]
A[a] --> C(c)
		C-->G(g)
    C --> h[h]
   
```



è§£é‡Šä¸‹è¿™å¼ å›¾, a ç½‘é¡µé‡ŒåŒ…å«äº†ä¸¤ä¸ª b å’Œ c ç½‘é¡µ. å½“çˆ¬å–å®Œ  a å, æ·±åº¦åŠ ä¸€. ç»§ç»­å¼€å§‹çˆ¬å– b å’Œ c çš„ç½‘é¡µ, b åˆæœ‰ e å’Œ f, m, c ç½‘é¡µåˆæœ‰é“¾æ¥ g å’Œ h. å½“ g å’Œ h çˆ¬å–å®Œå, æ·±åº¦ç»§ç»­åŠ ä¸€. å°±è¿™æ ·é€šè¿‡è·Ÿè¸ªæ·±åº¦, å°±èƒ½åœ¨åˆé€‚çš„æ—¶æœºé€€å‡ºæ¥. 

### robot.txt

ä½†æ˜¯çˆ¬è™«å¹¶ä¸æ˜¯è‚†æ— å¿Œæƒ®çš„. ä¸€èˆ¬ç½‘ç«™éƒ½ä¼šæœ‰ä¸€ä¸ª [robot.txt](https://en.wikipedia.org/wiki/Robots_exclusion_standard) æ–‡ä»¶, æ¥å‘Šè¯‰çˆ¬è™«: å“ªäº›è·¯å¾„æ˜¯è¿è¡Œçˆ¬å–çš„, è€Œå“ªäº›è·¯å¾„æ˜¯ä¸è¿è¡Œçˆ¬å–çš„.
çˆ¬è™«å¿…é¡»éµå®ˆå®ƒçš„è§„åˆ™, å¦åˆ™æœ¬åœ°çš„ IP å¾ˆå®¹æ˜“è¢«ç½‘ç«™åŠ å…¥é»‘åå•, å†ä¹Ÿä¸èƒ½è®¿é—®è¯¥ç½‘ç«™. æ‰€ä»¥æˆ‘ä»¬çš„çˆ¬å–ç­–ç•¥ä¹Ÿè¦åšå‡ºä¿®æ”¹, åœ¨å¼€å§‹çˆ¬å–ä¹‹å‰å…ˆè¯»å–ç«™ç‚¹çš„ robot æ–‡ä»¶.
è¿™ä¸ªæ–‡ä»¶çš„ä½ç½®å¾ˆæœ‰è®²ç©¶, ä¸€èˆ¬éƒ½ä½äºç½‘ç«™çš„æ ¹ç›®å½•ä¸‹. æ¯”å¦‚ Stack Overflow çš„ robot åœ°å€åº”è¯¥æ˜¯ `stackoverflow.com/robot.txt`.

å®ƒçš„ robots éƒ¨åˆ†æ ·å­

![Stack Overflow robots](/Users/yk/Documents/paper/pages/image-20180422233144683.png)

é’ˆå¯¹è¿™ç§ç®€å•å½¢å¼çš„ robot, å¯ä»¥å®ç°ä¸€ä¸ªè‡ªå·±çš„è§£æå‡½æ•°

```js
const fetchRobot = async url => {
  const robotUrl = `${url}/robots.txt`;
  const disallow = [];
  if (robotUrl) {
    const robot = await fetch(robotUrl).then(res => res.text());
    robot
      .split('\n')
      .filter(str => str.startsWith('Disallow'))
      .forEach(ban => disallow.push(ban.slice(ban.indexOf('/'))));
  }
  return disallow;
};
```

å› ä¸ºç»“æ„çš„å•ä¸€, åªéœ€è¦å–å‡ºæ‰€æœ‰ä»¥ `Disallow` å¼€å¤´çš„è¡Œçš„é“¾æ¥, å¾—åˆ°ä¸€ä¸ªæ•°ç»„. å› ä¸ºè¿™ä¸ªæ•°ç»„ä¹Ÿä¸é•¿, åœ¨æ£€æµ‹æ—¶å€™æ˜¯åˆæ³•é“¾æ¥çš„æ—¶å€™, å¯ä»¥å°è¯•ä¸€ç§ååˆ†ä½æ•ˆä½†æ˜¯ç®€å•çš„æ–¹å¼: å¯¹äºçˆ¬å–çš„æ¯ä¸ªé“¾æ¥éƒ½åœ¨è¿™ä¸ªæ•°ç»„ä¸­æ£€æŸ¥ä¸€ä¸‹.

## Scrapy

å¯æ˜¯ä¸ºäº†å®ç°ä¸€ä¸ªæœç´¢å¼•æ“, ä¸Šé¢çš„è¿™ç§æ–¹æ³•å°±ä¸è¡Œäº†, **å®ƒä¸å¤Ÿå¿«**. æµªè´¹å¤ªå¤šç¬”å¢¨æ¥å¼ºè°ƒå¦‚æœå†™å‡ºä¸€ä¸ªé«˜æ€§èƒ½çš„ Nodejs çˆ¬è™«æ˜¯ä¸åˆ’ç®—çš„. ä»‹ç» Scrapy ä¸€ä¸ªå¼ºå¤§çš„ Python çˆ¬è™«æ¡†æ¶æ¥å®Œæˆ YSE æ¥ä¸‹æ¥çš„çˆ¬å–ä»»åŠ¡.

å®˜æ–¹å¯¹å®ƒçš„ä»‹ç»æ˜¯:

> An open source and collaborative framework for extracting the data you need from websites.
>
> In a fast, simple, yet extensible way.



æ³¨æ„ç¬¬äºŒå¥, **yet extensible  way** æ»¡è¶³äº†æ€§èƒ½ä¸Šçš„éœ€æ±‚. è€Œä¸Šé¢æåˆ°çš„çˆ¬è™«éœ€è¦æ³¨æ„çš„é—®é¢˜, å®ƒå·²ç»å…¨éƒ¨æŠ½è±¡äº†. ä½¿ç”¨è€…åªéœ€è¦ä¸“æ³¨äºå¦‚ä½•ç¼–å†™çˆ¬è™«çš„é€»è¾‘, ä¸éœ€è¦è€ƒè™‘å…¶ä»–çš„ç»†èŠ‚.



æ ¹æ®å®˜æ–¹æ–‡æ¡£, å¯ä»¥å¾ˆå®¹æ˜“å†™å‡ºå‡ ä¸ªçˆ¬è™«, ç”¨æ¥çˆ¬å–ç‰¹å®šçš„å†…å®¹. ä»¥ Stack Overflow å®˜ç½‘ä¸ºä¾‹, å¦‚æœæƒ³çŸ¥é“ä»Šå¤©çš„é—®é¢˜æœ‰å“ªäº›, å¯ä»¥è‡ªå·±ä¸Šæµè§ˆå™¨è¾“å…¥, https://stackoverflow.com/?tab=featured. ä¹Ÿå¯ä»¥æ‰‹åŠ¨å†™ä¸€ä¸ªçˆ¬è™«, æ¥çˆ¬å–å…³æ³¨çš„ä¿¡æ¯. è¿™é‡Œä»¥è·å¾—æ¯ä¸ªé—®é¢˜çš„

- æŠ•ç¥¨æ•°
- å›ç­”æ•°
- æµè§ˆé‡
- æ ‡é¢˜

ä¸ºä¾‹, å¯ä»¥å†™å‡ºä¸‹é¢ä»£ç 

```python
import scrapy

class StackSpider(scrapy.Spider):
    name = 'stackoverflow'
    start_urls = [
        'https://stackoverflow.com/?tab=featured',
    ]

    def parse(self, response):
        for question in response.css('.question-summary'):
            yield {
                'votes':
                question.css(
                    'div.votes .mini-counts span::text').extract_first(),
                'views':
                question.css(
                    'div.views .mini-counts span::text').extract_first(),
                'answers':
                question.css(
                    'div.answered .mini-counts span::text').extract_first(),
                'title':
                question.css('.summary > h3 > a.question-hyperlink::text')
                .extract_first(),
            }

```

ä»£ç ä¸­çš„ CSS ä¸ä»…ä»…éµå¾ªäº† w3c æ ‡å‡†, è€Œä¸”è¿˜åšåˆ°äº†æ‰©å±•. åœ¨ cherrio ä¸­, æ‰¾åˆ°æŸä¸ªç‰¹å®šé€‰æ‹©å™¨çš„å…ƒç´ é‡Œçš„æ–‡æœ¬å†…å®¹, éœ€è¦  `$('.votes .mini-couts span').text()`, è€Œ scrapy é€šè¿‡ä¸€ç§ç±»ä¼¼äº**ä¼ªå…ƒç´ çš„æ‹“å±•**åšåˆ°äº†å¯ä»¥è·å¾— text çš„å†…å®¹.

æ¥ç€åœ¨å‘½ä»¤è¡Œä¸­è¿è¡Œ

```bash
scrapy crawl stackoverflow -o stackoverflow.json
```

è¿™æ ·å¯ä»¥å°†æ‰€æœ‰çˆ¬å–åˆ°çš„å†…å®¹æ•´ç†æˆä¸€ä¸ª JSON æ–‡ä»¶. æœ‰äº† JSON æ–‡ä»¶, ç›¸æ¯”æ¯æ¬¡æœç´¢éƒ½ç«‹åˆ»å»çˆ¬å–æ•°æ®, é€Ÿåº¦å°±èƒ½å¿«å¾ˆå¤š.



## å‰åç«¯

æœ‰äº†æ•°æ®, å°±å¼€å§‹åˆ©ç”¨å®ƒä»¬. å¯ä»¥å¼€å§‹å¿«é€Ÿæ­å»ºå¼€å‘æ‰€éœ€è¦çš„ä»£ç äº†. 

### åç«¯

åŸºäº Nodejs çš„åº”ç”¨éƒ½ç¦»ä¸å¼€åŒ…ç®¡ç†å·¥å…·, ä½†æ˜¯å®ƒåˆä¸åŒäº Python ä¸­çš„ `pip`. `pip` åœ¨å®‰è£…äº†æŸä¸ªåŒ…å, å°±å¯ä»¥åœ¨ä»»æ„ä»£ç ä¸­ `import` å¯¼å…¥å®ƒ. è€Œ Nodejs çš„ npm æˆ–è€… yarn, åªèƒ½æ¯ä¸€ä¸ªå¼€å‘ç¯å¢ƒéƒ½è£…ä¸€æ¬¡, ç¬¬ä¸€æ¬¡çœ‹åˆ°ä¼šè§‰å¾—éå¸¸éº»çƒ¦. è¿™æ˜¾ç„¶å’Œ JavaScript è¿™ä¸ªè¯­è¨€çš„èƒŒæ™¯æœ‰å…³, å› ä¸ºå®ƒæœ€æ—©çš„å®šä½å°±æ˜¯åœ¨æµè§ˆå™¨ä¸­è¿è¡Œ, è€Œä¸”æ˜¯ä¸€æœ¬è„šæœ¬è¯­è¨€. åœ¨æµè§ˆå™¨ä¸­è¿è¡Œè¯´æ˜å®ƒçš„æƒé™è‚¯å®šä¼šè¢«é™åˆ¶, åªèƒ½è¯»å–ç›¸å¯¹è·¯å¾„çš„æ–‡ä»¶. åŒæ—¶, åˆå› ä¸ºå®ƒæ˜¯è„šæœ¬è¯­è¨€, åªä¼šåœ¨è¿è¡Œçš„æ—¶å€™å¼€å§‹è¯»å–æ‰€éœ€è¦çš„èµ„æº. 

ä¸è¿‡, Nodejs ä½œä¸ºä¸€ä¸ªè¿è¡Œæ—¶ç¯å¢ƒ, ä¹Ÿæœ‰è‡ªå·±çš„ä¸€äº›å†…ç½®ç»„ä»¶. è¿™äº›ç»„ä»¶å·²ç»è¢«é¢„è£…åœ¨ Nodejs ä¸­, å¯ä»¥åœ¨ä»»ä½•é¡¹ç›®ä¸­ç›´æ¥è¯»å–. 

å¼€å§‹å®‰è£…æ‰€éœ€è¦çš„åŒ…:

```bash
mkdir myproject && cd $_ && yarn add koa koa-router axios classnames
```

å› ä¸ºå·²ç»å°†çˆ¬è™«çš„å·¥ä½œäº¤ç»™ scrapy, æš‚æ—¶å°±ä¸ç”¨å®‰è£… cherrio äº†. 

ç°åœ¨åªæ˜¯åªæ˜¯ä¸ºäº†çœ‹çœ‹æˆæœ, æœåŠ¡ç«¯ä»£ç è¿˜ä¸ä¼šå¤šä¹ˆå¤æ‚, æ·»åŠ ä¸€ä¸ªè·¯ç”±å°±è¡Œäº†.

```js
import Koa from 'koa';
import router from './route';
const app = new Koa();

app.use(router.routes());

app.listen(3001);

```

åŠ èµ·æ¥ä¹Ÿå°± 5 è¡Œä»£ç , è¿è¡Œåå°±èƒ½ç›‘å¬ 3001 ç«¯å£. ç¬¬äºŒè¡Œçš„ route.js é‡Œé¢æœåŠ¡ç«¯å’Œè·¯ç”±æœ‰å…³çš„ä»£ç . åªéœ€è¦æœç´¢çš„åŠŸèƒ½, æ‰€ä»¥åªå®šä¹‰ä¸€ä¸ª `/search` è·¯ç”±å°±å·²ç»å¤Ÿäº†. è¿™æ®µä»£ç ä¹Ÿå¾ˆç®€å•

```js
import fs from 'fs';
import path from 'path';
import { promisify } from 'util';
import Router from 'koa-router';
import { URL } from 'url';

const readFile = promisify(fs.readFile);

const router = new Router();
const filePath = path.resolve(__dirname, '../db/stackoverflow.json');
let index = null;

router.get('/search', async ctx => {
  const params = new URL('http://localhost' + ctx.url);
  const q = params.searchParams.get('q');

  try {
    if (index === null) {
      const txt = await readFile(filePath, {
        encoding: 'utf-8',
      });
      index = JSON.parse(txt);
    }

    const search = index.filter(question => question.title.includes(q));
    if (!search.length) {
      ctx.body = 'Nothing search';
      return;
    }

    ctx.body = JSON.stringify(search);
  } catch (err) {
    console.log('file not found');
    ctx.body = 'Bad!';
    ctx.status = 404;
  }
});

export default router;

```

å…³é”®é€»è¾‘å°±åœ¨ `const search = index.filter(question => question.title.includes(q))` è¿™ä¸€è¡Œ. ç›®å‰ç”¨äº†ä¸€ç§å¾ˆå¹¼ç¨šå¾ˆæ…¢çš„æ£€ç´¢æ–¹æ³•, åœ¨ Stack Overflow çš„ feature ä¸­é€å­—é€å¥çš„åŒ¹é… title. 



### å‰ç«¯

ç°åœ¨åªéœ€è¦å±•ç¤ºæœç´¢çš„ç»“æœ, æ‰€ä»¥ä¸éœ€è¦æ³¨æ„åŠ›è¿‡åˆ†æ”¾åœ¨ UI ä¸Š. React ä»£ç ä¸€èˆ¬ä¼šåˆ†ç¦»ä¸¤ç§æ¦‚å¿µ, ä¸€ç§ä¸“é—¨ç”¨æ¥æ¸²æŸ“ UI ä¸å…³å¿ƒä»»ä½•ä¸šåŠ¡é€»è¾‘çš„ç»„ä»¶â€”Component, å¦å¤–ä¸€ç§åˆ™æ˜¯ä»…ä»…å…³æ³¨ä¸šåŠ¡é€»è¾‘ä½†ä¸å…³å¿ƒ UI çš„ç»„ä»¶â€”Container.



å°±æ¯”å¦‚, ä¸€ä¸ª List ç»„ä»¶, å¯ä»¥å†™æˆä¸‹é¢è¿™æ ·å­

```jsx
const List = ({data, onClick}) => (
	<ul>
		{data.map(({title, value}) => (
			<li key={title} onClick={onClick}>{value}</li>
		))}
	</ul>
)
```

è¿™ä¸ªç»„ä»¶åªéœ€è¦ä¸¤ä¸ª props, ä¸€ä¸ª data ç”¨æ¥æ§åˆ¶éœ€è¦å±•ç¤ºçš„æ•°æ®, ä¸€ä¸ª onClick æ˜¯ç”¨æ¥å“åº”åˆ—è¡¨è¢«ç‚¹å‡»çš„äº‹ä»¶. è€Œå®ƒæ²¡æœ‰å…³æ³¨å¦‚æœè‡ªå·±ç¼–å†™é€»è¾‘, æ‰€æœ‰æ•°æ®éƒ½æ˜¯ç”±å…¶ä»–çš„ç»„ä»¶æ¥ä¼ å…¥. è¿™å°±æ˜¯ Component çš„æœ¬è´¨.

åŒæ ·çš„, å¯¹åº”çš„ Container çš„ä»£ç å¯ä»¥æ˜¯

```jsx
class View extends React.Component {
  data = [{title: 'good', value: 'oo'}, {title: 'bad', value: 'xx'}]
  
  onClick = () => alert('You click me!')
  
  render() {
    return <List data={this.data} onClick={this.onClick} />
  }
}
```

è™½ç„¶è¿™ä¸ªç¼–é€ çš„ä¾‹å­çœ‹ä¸Šå»å¾ˆç”Ÿç¡¬, ä½†æ˜¯å·²ç»å¾ˆå¥½çš„å®Œæˆäº†å®ƒçš„ä»»åŠ¡â€”å®ç°ä¸šåŠ¡é€»è¾‘



å›åˆ°å‰ç«¯çš„ä»£ç ä¸Šæ¥, ç›®å‰çš„å®ç°åªéœ€è¦æœ‰ä¸€ä¸ªæœç´¢æ¡†, èƒ½åœ¨è¾“å…¥å®Œæˆå, å‘åç«¯å‘é€ä¸€ä¸ªè¯·æ±‚, å¤„ç†åˆ†æåç«¯è¿”å›çš„æ•°æ®å¹¶å±•ç¤ºå‡ºæ¥. 

å¤§æ¦‚æµç¨‹æ˜¯è¿™æ ·

```sequence
æµè§ˆå™¨ -> æœåŠ¡å™¨: çœ‹åˆ°æˆ‘è¦æœç´¢çš„ä¸œè¥¿äº†å—?
Note right of æœåŠ¡å™¨: ä»ç£ç›˜ä¸­è¯»å–çˆ¬è™«æ•°æ®, å¼€å§‹åŒ¹é…
æœåŠ¡å™¨ -> æµè§ˆå™¨: è¿™æ˜¯ä½ çš„æœç´¢ç»“æœ, æ‹¿å»
```



ä¸‹é¢æ˜¯ç‚¹å‡»æœç´¢åçš„é€»è¾‘ä»£ç :

```js
  onSearch = async event => {
    event.preventDefault();
    this.setState({ isSearching: true });
    try {
      const { data } = await axios.get('/search', {
        params: {
          q: this.state.searchValue,
        },
      });

      const response = Array.isArray(data)
        ? data.map(question => question.title).join('\n')
        : data;
      this.setState({
        response,
      });
    } finally {
      this.setState({ isSearching: false });
    }
  };
```

è¿™é‡Œçš„ `axios` å’Œå‰æ–‡çš„ `fetch` æ–¹æ³•çš„æ•ˆæœç±»ä¼¼, ä¸è¿‡ axios çš„å°è£…æ›´ä¸ºè‰¯å¥½, æ‰€ä»¥åæ–‡éƒ½ä¼šé‡‡ç”¨å®ƒ.

å±•ç¤º UI çš„ä»£ç å°±ä¸å±•ç¤ºäº†, ç›®å‰çš„æ•ˆæœå¦‚å›¾æ‰€ç¤º.

![show-1](/Users/yk/Documents/paper/pages/image-20180421224806611.png)

å¦‚æœè¾“å…¥ä¸€äº›æœç´¢å†…å®¹, æ¯”å¦‚ `curl` çš„è¯, å°±èƒ½å‡ºç°æœç´¢çš„ç»“æœ.

![æœç´¢ç»“æœ](/Users/yk/Documents/paper/pages/image-20180421224850808.png)

å¯ä»¥çœ‹åˆ°å·²ç»èƒ½æœç´¢å‡ºæ­£ç¡®çš„ç»“æœäº†.



# ç´¢å¼•

æœç´¢å¼•æ“ä¸ä»…ä»…æ˜¯å¸Œæœ›èƒ½æœç´¢åˆ°æŸä¸ªå…³é”®å­—, è¿˜è¦è·å¾—ç›¸åº”çš„é“¾æ¥, è¿™æ ·æ‰æœ‰æœç´¢çš„ä»·å€¼.

æ‰€ä»¥éœ€è¦ä¸€ä¸ªç»“æ„æ¥è®°å½•ä¸€ä¸ªå…³é”®å­—å¯èƒ½å‡ºç°åœ¨çš„æ‰€æœ‰ URL ä¸­. ä¸¾ä¸ªä¾‹å­

ç½‘é¡µ a å«æœ‰ 5 ä¸ª å•è¯: 

1. Thank
2. you
3. so
4. much
5. teacher

é‚£ä¹ˆå°±åº”è¯¥ç”Ÿæˆä¸€ä¸ªè¿™æ ·çš„ç´¢å¼•

```mermaid
graph TB

A[index] --> B(Thank)
	B-->link1(a)
A[index] --> C(you)
	C-->link2(a)
A[index] --> D(so)
	D-->link3(a)
A[index] --> E(much)
	E-->link4(a)
A[index] --> F(teacher)
	F-->link5(a)


```

æ¯ä¸€ä¸ªå•è¯éƒ½ä¿å­˜å¯¹å½“å‰ç½‘é¡µçš„å¼•ç”¨æ‰è¡Œ. å¯¹åº”åˆ° Js ä¸­, å°±åº”è¯¥æ˜¯

```js
const index = {
  'Thank': 'a',
  'you': 'a',
  'so': 'a',
  'much': 'a',
  'teacher': 'a',
}
```

å®é™…è¿‡ç¨‹ä¸­, ä¸€ä¸ªå•è¯è‚¯å®šä¸å¯èƒ½ä»…ä»…å‡ºç°åœ¨ä¸€ä¸ªç½‘é¡µä¸­, æ‰€ä»¥æ¯ä¸ªè¯å¯¹åº”çš„ä¸æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸², è€Œæ˜¯ä¸€ä¸ªæ•°ç»„. æ•°ç»„ä¿å­˜ç€è¿™ä¸ªå•è¯å‡ºç°è¿‡å¾—æ‰€æœ‰ç½‘é¡µé“¾æ¥æ‰è¡Œ.



## åŸºæœ¬å®ç°

å› ä¸ºç›®æ ‡æ˜¯è‹±æ–‡, ä½¿ç”¨ç©ºæ ¼å°±å¯ä»¥åˆ†è¯äº†.ç›¸æ¯”ä¸­æ–‡æ¥è¯´å¾ˆå®¹æ˜“å¤„ç†. ä¸è¿‡å› ä¸ºç©ºæ ¼åˆ†å‡ºæ¥çš„å¯èƒ½è¿˜å¸¦æœ‰æ ‡ç‚¹ç¬¦å·, æ‰€ä»¥éœ€è¦æŠŠå®ƒä»¬å»æ‰. å…ˆå®šä¹‰å‡ ä¸ªå¸¸ç”¨çš„æ ‡ç‚¹ç¬¦å·

```js
const punctuation = '!"#$%&\'()*+,-./:;<=>?@[\\]^_`{|}~';	
```

åœ¨ JS ä¸­, è¿™ç§ç±»å‹å¯ä»¥äº¤ç»™æ­£åˆ™è¡¨è¾¾å¼. æ¯”å¦‚ä¸€ä¸ªå¥å­, `your are, so good!`. è¦æƒ³æŠŠå®ƒæ‹†æˆ `['you', 'are', 'so', 'good']` çš„è¯, å†å°†ä¸Šé¢çš„æ ‡ç‚¹ç¬¦å·æ”¹ä¸ºæ­£åˆ™çš„å½¢å¼

```js
const reg = new RegExp(`[${punctuation}]`, 'gm')
```

æ¥ä¸‹æ¥å°±èƒ½é€šè¿‡å†…ç½®çš„ `replace` å‡½æ•°å°†æ ‡ç‚¹å…¨éƒ¨å»æ‰

```js
const words = txt.replace(reg, '').split(' ')
```

æˆåŠŸåˆ†è¯å, ä¸‹ä¸€æ­¥å°±æŠŠæ¯ä¸ªé“¾æ¥å’Œå•è¯å¯¹åº”ä¸Šæ¥. å…ˆä»¥ `cherrio` ä¸ºä¾‹å­, Stack Overflow ç½‘ç«™çš„æ­£æ–‡éƒ½æ˜¯åœ¨ä¸€ä¸ª `div.container` ä¸‹é¢, ä¹Ÿèƒ½åˆ¤æ–­å®ƒä»¬çš„ç½‘é¡µæ˜¯ç”± React ç¼–å†™çš„, å½“ç„¶è¿™æ˜¯åè¯äº†.

è¿è¡Œ `$('div.container').text().replace(reg, '').split(' ')` å°±èƒ½å°†æ•´ä¸ªç½‘ç«™çš„æ–‡æœ¬å…¨éƒ¨æ‹†åˆ†å¼€æ¥. æ¥ä¸‹æ¥éœ€è¦åšçš„äº‹æƒ…å°±æ˜¯å»ºç«‹ç´¢å¼•.

```js
const index = allPages.reduce((index, page) => {
  const words = cherrio(page)('div.container')
  	.text().replace(reg, '').split(' ');
  
  words.forEach(word => {
    if (index[word]) {
      index[word].push(url)
    }
    index[word] = [url]
  })
  
  return index
}, {})
```

åœ¨è¿™æ®µä»£ç ä¸­, å‡è®¾ allPages å°±æ˜¯æˆ‘ä»¬éœ€è¦éå†çš„æ‰€æœ‰çš„ç½‘é¡µæ•°æ®, é€šè¿‡éå†å®ƒæ¥è·å¾—å•ä¸ªç½‘é¡µçš„æ–‡æœ¬å†…å®¹. æ¥ä¸‹æ¥å°±åƒä¸Šé¢è¯´åˆ°ä¸€æ ·, å»ºç«‹ä¸€ä¸ªåˆ†è¯æ•°ç»„. ä¹‹åå†åˆ¤æ–­ç´¢å¼•ä¸­æ˜¯å¦å·²ç»æœ‰è¯¥å•è¯, ä½œå‡ºå¯¹åº”çš„é€»è¾‘. å…¶ä¸­`reduce` å’Œ `forEach` å¯ä»¥çœ‹æˆå¯¹ for å¾ªç¯çš„ä¸€ç§**æŠ½è±¡**

å°è¯•è¿è¡Œä¸€ä¸‹å, å¯ä»¥å¾—åˆ°ä¸‹é¢ç»“æœ

![ç´¢å¼•](/Users/yk/Documents/paper/pages/image-20180422180759934.png)

ä¸ºä»€ä¹ˆä¸€ä¸ª URL ä¼šè¢«å¤šæ¬¡åŠ è¿›æ¥å‘¢? åŸå› ä¹Ÿå¾ˆæ˜æ˜¾, æ•´ä¸ªç½‘é¡µçš„å•è¯å†—ä½™åº¦æ˜¯å¾ˆé«˜çš„, æ‰€ä»¥ä¸€ä¸ªå•è¯å‡ºç°çš„æ¬¡æ•°å¯èƒ½ä¸æ­¢ä¸€æ¬¡. è§£å†³è¿™ä¸ªé—®é¢˜çš„æ–¹æ³•æœ‰å‡ ç§, 

1. å°†æ•°ç»„æ”¹æˆ Set
2. æ¯æ¬¡æ’å…¥ä¹‹å‰æ£€æŸ¥æ•°ç»„çš„æœ€åä¸€ä¸ª URL æ˜¯å¦å’Œè¿™ä¸ª URL ç›¸åŒ

æœ¬æ–‡é€‰æ‹©ä½¿ç”¨ç¬¬äºŒç§æ–¹æ¡ˆ, å› ä¸ºæ¯ä¸ª URL åªä¼šè¢«çˆ¬å–ä¸€æ¬¡, æ¢å¥è¯è¯´, è¿™ä¸ªæ•°ç»„å³ä½¿å†—ä½™ä¸€å®šæ˜¯ `[a,a,a,a,b,b,b,c,c]` è¿™ç§å½¢å¼, è€Œä¸æ˜¯æ˜¯ `[a,a,a,b,b,a,b,a,c]` è¿™ç§å½¢å¼. è€Œç¬¬ä¸€ç§æ–¹æ³•, çœ‹ä¸Šå»åªéœ€è¦ $O(1)$ çš„æ—¶é—´å¤æ‚åº¦, ä½†æ˜¯ Set çš„åˆå§‹åŒ–è¿‡ç¨‹å¹¶ä¸é‚£ä¹ˆç®€å•. éœ€è¦ä¼´éšç€ä¸€ä¸ªæ¯”è¾ƒå¤§çš„ç©ºé—´ä¸€èµ·åˆ†é…å‡ºæ¥, åœ¨å•è¯é‡å¾ˆå¤§çš„æƒ…å†µä¸‹, æ€§èƒ½ä¹Ÿå¹¶ä¸é‚£ä¹ˆçªå‡ºå’¯. å¦å¤–ä¸ºäº†ä¿å­˜æˆ JSON,  Set å†è½¬åŒ–æˆæ•°ç»„ä¹Ÿæ˜¯æœ‰å¼€é”€çš„. 

æ‰€ä»¥å°† `if(index[word])` æ”¹ä¸º `if(index[word] and index[word][-1] != url)` æ¥è§£å†³è¿™ä¸ªé—®é¢˜.

## å’Œçˆ¬è™«æ•´åˆ

ç°åœ¨å·²ç»ç†æ¸…äº†åŸºæœ¬çš„é€»è¾‘, æ¥ä¸‹æ¥æ•´åˆè¿›çˆ¬è™«ä¸­. å›å¿†ä¸‹ä¹‹å‰çš„ strcpy çš„ä»£ç , `parse` å‡½æ•°æ˜¯çˆ¬è™«çš„å…³é”®é€»è¾‘æ‰€åœ¨, æ‰€ä»¥åªéœ€è¦å°†å»ºç«‹ç´¢å¼•çš„é€»è¾‘ä¹Ÿæ”¾åœ¨è¿™é‡Œ. å¹¶åœ¨çˆ¬è™«ç»“æŸå, å°†ç´¢å¼•ä¿å­˜æˆæ–‡ä»¶.

æ ¹æ® scrapy æ–‡æ¡£, `close` å‡½æ•°ä¼šåœ¨çˆ¬è™«ç»ˆæ­¢åè°ƒç”¨, æ‰€ä»¥å¯ä»¥åœ¨è¿™é‡Œå®ç°ä¿å­˜ç´¢å¼•çš„åŠŸèƒ½. 

```python
    def close(self):
        with open('./index.json', 'w') as f:
            f.write(json.dumps(self.index, indent=2))
```

è¿™æ˜¯åœ¨ä»¥ Stack Overflow ä¸ºç§å­ç½‘é¡µçˆ¬å–åçš„éƒ¨åˆ†ä¿å­˜ç»“æœ

```json
  "tsql": [
    "https://stackoverflow.com/?tab=month",
    "https://stackoverflow.com/users/2919045/hkravitz"
  ],
  "join": [
    "https://stackoverflow.com/help/badges/644/join?userid=650492",
    "https://stackoverflow.com/users/650492/johan?tab=badges",
    "https://meta.stackoverflow.com/questions/359465/should-serial-downvoter-be-punished-notify",
    "https://meta.stackoverflow.com/questions/251758/why-is-stack-overflow-so-negative-of-late",
    "https://stackoverflow.blog/2018/02/05/secret-behind-great-developer-onboarding/"
  ],
```

é—²æ‚çœ‹åˆ°æ¯ä¸ªå•è¯éƒ½å¯¹åº”ç€å®ƒå‡ºç°è¿‡çš„ç½‘é¡µçš„é“¾æ¥.

ä½†æ˜¯, è¿˜æœ‰ä¸€ä»¶å¾ˆé‡è¦çš„äº‹æƒ…è¢«é—å¿˜äº†. è‡ªç„¶è¯­è¨€çš„å†—ä½™åº¦å¾ˆé«˜, æŸäº›å•è¯æ¯ä¸ªç½‘é¡µå‡ºç°çš„é¢‘ç‡éƒ½ä¼šéå¸¸é«˜, ä½†æ˜¯å®ƒä»¬å¯¹äºæœç´¢çš„æ„ä¹‰ä¸å¤§. æ¯”å¦‚ *The, I, Do, You, How, What* è¿™äº›, æ‰€ä»¥åº”è¯¥åšä¸€äº›é¢„å¤„ç†æŠŠå®ƒä»¬å»æ‰, æœ¬æ–‡æ”¶é›†äº† 200 ä¸ªå·¦å³çš„**å ä½ç¬¦**.

åœ¨è¿™é‡Œå°±å¯ä»¥å°†è¿™äº›å ä½ç¬¦å­˜å‚¨ä¸ºä¸€ä¸ª Set , å¯¹æ¯ä¸ªå•è¯éƒ½è¿›è¡Œè¿‡æ»¤, å¾—åˆ°æœ€åçš„ç»“æœ.

```mermaid
graph LR

w1(I) --> Set
w2(Javascript) --> Set
Set --> A{Decision}
A -->|Yes| D(I)
A --> E(You)
A --> F(The)
A --> G(What)
```



### åç«¯åˆ©ç”¨

æœ‰äº†ç´¢å¼•å, åç«¯åªè¦åœ¨å¯åŠ¨çš„æ—¶å€™è¯»å–è¯¥æ–‡ä»¶, è½¬åŒ–æˆå­—å…¸, æ ¹æ®æœç´¢è¯æ¥æ˜ å°„.

```js
    if (index === null) {
      const txt = await readFile(filePath, {
        encoding: 'utf-8',
      });
      index = JSON.parse(txt);
    }

    const search = index[q];
    if (!Array.isArray(search)) {
      ctx.body = 'Nothing search';
      return;
    }

    ctx.body = search;
```

åŒæ ·çš„, åç«¯â€œæ¥å£â€æ”¹äº†, å‰ç«¯ä¹Ÿéœ€è¦åšä¸€ç‚¹å¤„ç†. ç°åœ¨æ”¶åˆ°çš„æ˜¯ URL æ•°ç»„, ä»…ä»…å°†æ•°ç»„è½¬åŒ–æˆå­—ç¬¦ä¸²æ¥å±•ç¤ºçš„è¯å¯ä¸è¡Œ, HTML ä¼šè‡ªåŠ¨å»é™¤æ¢è¡Œå’Œç©ºæ ¼, æ˜¾ç¤ºå‡ºæ¥çš„æ•ˆæœåªä¼šæ˜¯ä¸€é•¿ä¸² URL. å¯ä»¥å°†å®ƒä»¬è°ƒæ•´ä¸º ol çš„å½¢å¼æ¥å±•ç¤ºè¿™æ®µ UI.

```js
<div className="content">
  {Array.isArray(response) ? (
    <ol>
      {response.map(result => (
        <article className="message is-link" key={result}>
          <header className="message-header">
            <a href={result}>{result}</a>
          </header>
          <div className="message-body">You got me!!!</div>
        </article>
      ))}
    </ol>
  ) : (
    <p>Nothing Search.</p>
  )}
</div>
```

å…³é”®æ”¹åŠ¨æ˜¯è¿™ä¸€å—, åœ¨å°è¯•è¾“å…¥ react çš„æ—¶å€™.

![index preview](/Users/yk/Documents/paper/pages/image-20180424234455138.png)

å¯ä»¥å‘ç°ç´¢å¼•ä¸­æœ‰å››ä¸ªé“¾æ¥, å¹¶ä¸”å¯¹åº”çš„ URL é“¾æ¥éƒ½å·²ç»æ˜¾ç¤ºå‡ºæ¥. è€Œ *you got me* è¿™ä¸ªå ä½ç¬¦å¯ä»¥åœ¨åç»­é€šè¿‡æœåŠ¡å™¨é¢„å¤„ç†, å°†ç½‘é¡µçš„å†…å®¹ä¸€å¹¶è¿”å›å›æ¥.

è¿™æ ·, ç´¢å¼•çš„å»ºç«‹å°±å‘Šä¸€æ®µè½äº†. ä¸‹é¢ä»‹ç»ä¸€ä¸‹ Rank ç®—æ³•.



# æ’åºç®—æ³•

ç›®å‰ç´¢å¼•å·²ç»æ„å»ºå®Œæˆ, å½“æœç´¢**æŸä¸ªå•è¯**çš„æ—¶å€™, å¯ä»¥é€šè¿‡ç´¢å¼•æ‰¾åˆ°è¿™ä¸ªå•è¯å‡ºç°è¿‡å¾—æ‰€æœ‰ URL. ä½†æ˜¯ä¸€è‚¡è„‘çš„æŠŠè¿™äº› URL ä¸¢å‡ºæ¥æ˜¾ç„¶æ˜¯ä¸å¤Ÿçš„, éœ€è¦ç»™å‡ºä¸€ä¸ªç½‘é¡µæ’åçš„å®šä¹‰, å†å°†å®ƒä»¬æ’åº.



## æ¬¢è¿ç¨‹åº¦

åœ¨å®šä¹‰ç½‘é¡µä¹‹å‰, å…ˆæ‹¿æˆ‘ä»¬è‡ªå·±æ¥åšæ¯”æ–¹, ä¸€ä¸ªäººå—æ¬¢è¿çš„ä¸€ç§å¯èƒ½æ€§, æ˜¯å®ƒçš„æœ‹å‹å¤šå—? å‡è®¾ä¸€ä¸‹, ä¸€ä¸ªå¾®åšçš„å¤§ V, å®ƒçš„ç²‰ä¸æœ‰å‡ åƒä¸‡, åŒ…æ‹¬ä½œè€…æœ¬äºº. æ ¹æ®ä¸Šé¢è¯´æ³•, ç®—æ˜¯å¾ˆå—æ¬¢è¿çš„ä¸€ä¸ªäºº, ä½†æ˜¯é€šè¿‡ä»–çš„å¾®åšå‘ç°, ä»–çš„å¾®åšè½¬å‘é‡å’Œä»–çš„ç²‰ä¸æ•°çš„æœ‰æ•°æ®çº§çš„å·®åˆ«, å¯èƒ½åªæœ‰ä¸€ä¸¤ä¸‡æ¡. ä¸ºä»€ä¹ˆä¼šè¿™æ ·? å› ä¸ºä»–çš„ç²‰ä¸æœ‰å¾ˆå¤§ä¸€éƒ¨åˆ†æ˜¯åƒä½œè€…è¿™æ ·çš„ä»æ¥ä¸è¯„è®ºçš„å°ç™½, ç²‰ä¸çš„ç²‰ä¸ä¹Ÿå°‘çš„å¯æ€œ. è¿™ä¸€éƒ¨åˆ†ç”¨æˆ·å¯¹äºå¤§V æ¥è¯´å®Œå…¨æ²¡æœ‰**ä»»ä½•ä»·å€¼**, å……å…¶é‡åªæ˜¯ä¸€ä¸ªæ•°å­—ç½¢äº†. 
ç”¨äº’è”ç½‘æœ¯è¯­è§£é‡Š: **ä»…ä»…åªæ˜¯æµé‡, ä½†æ˜¯å®Œå…¨ä¸èƒ½å˜ç°.** æ‰€ä»¥è¿™ä¸ªå¾®åšå¤§ V å¹¶æ²¡æœ‰çœ‹ä¸Šå»çš„é‚£ä¹ˆå—æ¬¢è¿.

é‚£ä¹ˆåˆ°åº•æ€æ ·æ‰ç®—å—æ¬¢è¿å‘¢? æœ¬æ–‡ç»™å‡ºçš„å®šä¹‰æ˜¯ä¸€ä¸ªäºº, ä»–çš„æ‰€æœ‰æœ‹å‹å—æ¬¢è¿ç¨‹åº¦çš„æ€»å’Œ. ç”¨ä¸€ä¸ªå…¬å¼æ¥å®šä¹‰.
$$
Popularity(p) = \sum_{f\in p's friends}Popularity(f)
$$
è¿™ä¸ªå…¬å¼æœ‰ä¸€ä¸ªé—®é¢˜, å®ƒæ²¡æœ‰å®šä¹‰ä¸€ä¸ªåˆå§‹æƒ…å†µ. å› ä¸º **ä¸å¥½å®šä¹‰**. 

å°è¯•å®šä¹‰ä¸€ä¸ªæ²¡æœ‰ä»»ä½•æœ‹å‹çš„äººæ¬¢è¿ç¨‹åº¦ä¸º 1? é‚£å¦‚æœä»–ä¸€ä¸ªæœ‹å‹éƒ½æ²¡æœ‰, æ ¹æœ¬å°±ä¸ä¼šå‡ºç°åœ¨è¿™ä¸ªå…¬å¼ä¸­, å› ä¸ºæ ¹æœ¬æ— æ³•å¼•ç”¨åˆ°ä»–. 
é‚£å®šä¹‰æŸä¸ªäººçš„æ¬¢è¿ç¨‹åº¦ä¸º 1? è¿™ä¼¼ä¹ä¹Ÿä¸è¡Œ, å› ä¸ºä¸æ˜¯æ¯ä¸ªäººéƒ½ä¼šå’Œä»–æˆä¸ºæœ‹å‹. é’ˆå¯¹è¿™ç§ä¸å¥½å®šä¹‰çš„é—®é¢˜, å¯ä»¥é‡‡ç”¨**æ¾å¼›ç®—æ³•**

å®ƒçš„æ€è·¯æ˜¯ä¸æ–­çš„å°è¯•. å…ˆå®šä¹‰ä¸€ä¸ªåˆå§‹çš„ç»“æœ(è¿™ä¸ªç»“æœå¯ä»¥éšä¾¿å®š), ç„¶åé€šè¿‡ä¸æ–­åœ°è°ƒæ•´ç›´åˆ°æ¯ä¸ªæ¡ä»¶æˆç«‹çš„æ—¶å€™ä¸ºæ­¢. å›æƒ³æ±‚ x çš„å¹³æ–¹æ ¹, å®ƒçš„æ€è·¯å°±æ˜¯å…ˆå‡è®¾ç»“æœæ˜¯ g, è¿™é‡Œ g å®šä¹‰æˆ 1 å°±å¥½. é€šè¿‡ä¸æ–­åœ°å¯¹æ¯” x / g å’Œ g çš„å€¼æ˜¯å¦è¶³å¤Ÿæ¥è¿‘, ä¸æ»¡è¶³çš„è¯ç»§ç»­è°ƒæ•´, ç›´åˆ°å¾—åˆ°æ»¡è¶³æœ€ç»ˆæ¡ä»¶. è€Œè¿™ç§çŒœæµ‹æ–¹æ³•å°±è¢«ç§°ä¸º ç‰›é¡¿è¿­ä»£æ³•[^2]

è€Œåœ¨æœ¬æ–‡çš„ä¾‹å­ä¸­, å¯¹äºå—æ¬¢è¿å¹¶æ²¡æœ‰ä¸€ä¸ªåƒæ•°å­¦ä¸€æ ·å¯èƒ½ç¡®å®šçš„å€¼, æ‰€ä»¥è°ƒä¼˜çš„æ–¹å¼æ¯”è¾ƒç®€å•. å°±æ˜¯å¤šè¿è¡Œå‡ æ¬¡. åƒä¸‹é¢çš„å…¬å¼ä¸€æ ·
$$
Popularity(p, t)_{t == 0} = 1
$$

$$
Popularity(p, t)_{t > 0} =  \sum_{f\in p's friends}Popularity(f, t - 1)
$$



## ç½‘é¡µæ’åº

ç°åœ¨å›åˆ°ç½‘é¡µæ’åºæœ¬èº«, å®šä¹‰ä¸€ä¸ªç½‘é¡µçš„ Rank æŒ‡æ ‡ä¸º

> å…¶ä»–æœ‰é“¾æ¥æŒ‡å‘è¯¥ç½‘é¡µçš„ç½‘é¡µ Rank ä¹‹å’Œ

è€Œæ¯ä¸€ä¸ªç½‘é¡µçš„åˆå§‹ Rank å¯ä»¥çœ‹æˆæœåŠ¡å™¨éšæœºè®¿é—®åˆ°è¿™ä¸ªç½‘é¡µçš„æ¦‚ç‡ , é€šä¿—ç‚¹å°±æ˜¯ $1/n$

é€šè¿‡ä»ä¸€ä¸ªéšæœºç½‘é¡µå¼€å§‹è®¿é—®, ä¸æ–­åœ°é‡å¤è¿™ä¸ªè¿‡ç¨‹, ç®—å‡ºæ¯ä¸ªç½‘é¡µè¢«è®¿é—®è¿‡çš„æ¬¡æ•°, å°±èƒ½å¾—åˆ°ç½‘é¡µçš„ Rank. å’Œä¸Šé¢çš„åˆ¤æ–­å¥½å‹å—æ¬¢è¿ç¨‹åº¦çš„æ–¹æ³•å¾ˆç±»ä¼¼:
$$
Rank(url, 0) = 1
$$

$$
Rank(url, t) = \sum_{p\in inlinks[url]} rank(p, t - 1)
$$

ä¸è¿‡è€ƒè™‘åˆ°ä¸€ä¸ªç½‘é¡µä¸­å¯ä»¥æœ‰å¤šæ¡é“¾æ¥, ä¸ºäº†å…¬å¹³,  åº”è¯¥å°†å¤šæ¡é“¾æ¥çš„ç½‘é¡µçš„æƒé‡é™ä½. æ‰€ä»¥è°ƒæ•´å…¬å¼ä¸º 
$$
Rank(url, t) = \sum_{p\in inlinks[url]} rank(p, t - 1) / outlinks[p]
$$
è¿™é‡Œçš„ $outlinks[p]$ æŒ‡çš„å°±æ˜¯ç½‘é¡µ p çš„é“¾æ¥æ•°.

æœ€å, è¿˜æœ‰ä¸€ä¸ªå°é—®é¢˜. ä¸€ä¸ªæ–°çš„ç½‘é¡µ, å¯èƒ½æ ¹æœ¬æ²¡æœ‰å¤–éƒ¨é“¾æ¥æŒ‡å‘å®ƒ, æ ¹æ®ä¸Šé¢çš„å…¬å¼å®ƒä»¬çš„ Rank å°±ä¼šæ˜¯ 0, è¿™æ ·æ˜¾ç„¶ä¸å¤Ÿä¼˜åŒ–. ä¸€ä¸ªç½‘é¡µéƒ½ä¸ä¼šè¢«å‘ç°äº†, æ€ä¹ˆè¦æ±‚æ›´å¤šç½‘é¡µâ€œè®¤è¯†å®ƒå‘¢â€. é€šè¿‡å¼•å…¥ä¸€ä¸ª**é˜»å°¼å¸¸é‡**, å¾®è°ƒå…¶ä»–ç½‘é¡µå†³å®šæ’åçš„å æ¯”, ç»™æ¯ä¸ªç½‘é¡µä¸€ä¸ªèµ·å§‹ Rank, å°±èƒ½ä¿è¯ä¸ä¼šå‡ºç° 0 çš„æƒ…å†µ. æœ€åçš„å…¬å¼ä¸º
$$
Rank(url, 0) = 1 / npages
$$

$$
Rank(url, t) = (1 - d) / npages + \sum_{p\in inlinks[url]} d â€¢ rank(p, t - 1) / outlinks[p]
$$

## å®ç°æ–¹å¼

è€ƒè™‘ä¸‹é¢çš„å›¾ç‰‡, èŠ‚ç‚¹è¡¨ç¤ºç½‘é¡µ, è¾¹è¡¨ç¤ºç½‘é¡µæŒ‡å‘çš„ç½‘é¡µ. 

```mermaid
graph TB

A(a) --> B(b)
A(a) --> C(c)
A(a) --> D(d)
C --> A



```

ä»£ç çš„ç»“æ„å¯ä»¥ä¸º

```js
const graph = {
  a: ['b', 'c', 'd'],
  b: [],
  c: ['a'],
  d: []
}
```

å…¶å®ä¹‹å‰çš„çˆ¬è™«å·²ç»å®ç°äº†è¿™ä¸ªåŠŸèƒ½, å¹¶å°†å®ƒä¿å­˜ä¸º JSON æ–‡ä»¶. æ¥ä¸‹æ¥åªéœ€è¦æ ¹æ®ä¸Šé¢çš„å…¬å¼å†™å‡ºä»£ç .

```js
function computeRanks(graph) {
  const damping = 0.8;
  const loops = 10;
  let ranks = {};

  const pages = Object.keys(graph);
  const { length } = pages;
  pages.forEach(link => (ranks[link] = 1.0 / length));

  for (let i = 0; i < loops; i += 1) {
    const newranks = {};
    for (const page of pages) {
      let newrank = (1 - damping) / length;
      for (const node of pages) {
        if (graph[node].includes(page)) {
          newrank += damping * (ranks[node] / graph[node].length);
        }
      }
      newranks[page] = newrank;
    }
    ranks = newranks;
  }
  return ranks;
}
```

ä¸ºäº†æ€§èƒ½ä¸Šè€ƒé‡, ä»£ç çš„å®ç°ä¸èƒ½åƒæ•°å­¦å…¬å¼é‚£æ ·ä½¿ç”¨é€’å½’, å› ä¸º graph çš„æ•°æ®é‡å¯èƒ½éå¸¸å¤§, å¾ˆå®¹æ˜“å¯¼è‡´æ ˆæº¢å‡º. è¿™æ®µä»£ç  for å¾ªç¯å¤ªå¤š, ä¸æ˜¯å¾ˆä¼˜é›…. å¯ä»¥è€ƒè™‘ä½¿ç”¨ `reduce` å’Œ `forEach` ç­‰å‡½æ•°æ¥ç®€åŒ–. ä¸»è¦éœ€è¦æ³¨æ„ `for (const page of pages) {` è¿™ä¸€è¡Œå¼€å§‹, ä¸‹ä¸€è¡Œçš„ `newrank` å°±æ˜¯æ¯ä¸ªç½‘é¡µçš„åˆå§‹ rank, è€Œ page ä¹Ÿå°±æ˜¯æœ¬æ¬¡è®¡ç®— rank çš„ç½‘é¡µ. æ¥ä¸‹æ¥åˆæ˜¯ä¸€ä¸ª for å¾ªç¯, `graph[node]` çš„æ„ä¹‰æ˜¯ä¸€ä¸ªç½‘é¡µçš„æ‰€æœ‰å¤–é“¾. æ‰€ä»¥è¿™æ®µ if è¯­å¥çš„åŠŸèƒ½å°±æ˜¯: å¦‚æœæŸä¸ªç½‘é¡µçš„å¤–é“¾ä¸­æœ‰å®ƒ, å°±å¢åŠ  rank çš„å€¼. æœ€ååªéœ€è¦å°†å½“å‰ç½‘é¡µçš„ rank å€¼å­˜å…¥ ranks å­—å…¸ä¸­.

éœ€è¦æ³¨æ„çš„æ˜¯, å¦‚æœä¸€ä¸ªç½‘é¡µå¤–é“¾äº†å¦å¤–ä¸€ä¸ªç½‘é¡µå¤šæ¬¡, åœ¨æœ¬ç®—æ³•ä¸­ä¹Ÿåªä¼šå¢åŠ ä¸€æ¬¡ rank å€¼.

æœ‰ä¸ªä¸Šé¢çš„ç®—æ³•, å¯ä»¥å¯¹çˆ¬è™«æœé›†çš„ä¿¡æ¯è¿›è¡Œä¸€ä¸ªå¤„ç†. å°† ranks ä¿å­˜æˆ JSON å, å¯ä»¥å¾—åˆ°.

![rank ç»“æœ](/Users/yk/Documents/paper/pages/image-20180428145819196.png)

æ¥ä¸‹æ¥æŠŠ ranks, index ç»„åˆèµ·æ¥, çœ‹çœ‹ç°åœ¨æœç´¢å¼•æ“çš„æ•ˆæœ.



é¦–å…ˆéœ€è¦æ”¹å†™æœåŠ¡ç«¯çš„ä»£ç . ç›¸æ¯”ä¹‹å‰åªéœ€è¦è¯»å– index çš„æ–‡ä»¶, ç°åœ¨è¿˜éœ€è¦è¯»å– ranks çš„æ–‡ä»¶.

```js
const reads = Promise.all([
	readFile(indexFilePath, 'utf-8'),
	readFile(rankFilePath, 'utf-8'),
]);
[index, rank] = (await reads).map(JSON.parse);
```

è¿™é‡Œå°±æ˜¯åŒæ—¶è¯»å–ä¸¤ä¸ªæ–‡ä»¶, å°†å®ƒä»¬ç”± JSON è½¬ä¸º JS å¯¹è±¡, å¹¶èµ‹å€¼ç»™å¯¹åº”å˜é‡.

æ¥ä¸‹æ¥çš„è¿‡ç¨‹å°±æ˜¯é€šè¿‡ index è·å¾—æœç´¢å…³é”®è¯å¯¹åº”çš„ URL æ•°ç»„, å¯¹åº”åˆ° rank å­—å…¸ä¸­, æ ¹æ®å¯¹åº”çš„ rank å€¼, æ’åºåå±•ç¤ºå‡ºæ¥. 

```mermaid
graph LR

A(Javascript) --> B(index)
B --> HTML
B --> CSS
B --> Java
B --> C[Javascript]

C --> D(a.com, b.c.com, qq.com)

R(rank) --> |a.com|r1(0.1)
D --> r1
R --> |b.com|r2(0.2)
D --> r2
R --> |qq.com|r3(0.3)
D --> r3

r1 --> Result(qq.com, b.com, a.com)
r2 --> Result
r3 --> Result

Result --> æµè§ˆå™¨
```

å¦‚ä¸Šå›¾æ‰€ç¤º, ç®€å•å±•ç¤ºäº†è¿™ç§è¡Œä¸ºçš„æ¨¡å‹.

```js
const search = index[q];
const sortSearchResult = pipe(
  map(url => ({
    url,
    rank: rank[url],
  })),
  sortWith([descend(prop('rank'))]),
  tap(console.log),
  pluck('url'),
);
const getResult = ifElse(is(Array), sortSearchResult, () => 'Nothing Search');
ctx.body = getResult(search);

```

map çš„è¿™ä¸€æ ·å°±æ˜¯æ ¹æ® URL æ•°ç»„è¿”å›ä¸€ä¸ªå¯¹è±¡æ•°ç»„, å¯¹è±¡çš„å±æ€§ä¸º URL å’Œ Rank å€¼. æ¥ç€æ ¹æ® Rank å€¼æ¥æ’åºè¯¥æ•°ç»„, æœ€åå†å°† Rank å€¼å‰”é™¤å¹¶è¿”å›ç»™æµè§ˆå™¨. `tap` çš„ç›®çš„ä¸»è¦æ˜¯åœ¨ä¸­é—´æ’å…¥ä¸€æ®µ log, å¹¶æ²¡å¯¹æ•°æ®åšä»€ä¹ˆå¤„ç†.

æœ€åæœç´¢: *map*, è§‚å¯ŸæœåŠ¡å™¨çš„æ—¥å¿—.

```js
{ url: 'https://meta.stackoverflow.com/users/634474/dymmeh',
     rank: 0.00033062140083032 },
   { url: 'https://stackoverflow.com/users/8013925/jdickel',
     rank: 0.00033049353701527606 },
   { url: 'https://stackoverflow.com/users/679671/swordfish',
     rank: 0.00033039170373793975 },
   { url: 'https://meta.stackoverflow.com/users/298661/puppy',
     rank: 0.00033039170373793975 },
   { url: 'https://stackoverflow.com/questions/27491601/c-getting-compilation-error-while-insert-string-into-a-map',
     rank: 0.00032894736842105257 },
  { url: 'https://meta.stackoverflow.com/questions/356091/show-anonymized-but-complete-voting-information-to-moderators',
     rank: 0.00032894736842105257 },
   { url: 'https://stackoverflow.blog/2008/10/12/a-question-about-questions/',
     rank: 0.00032894736842105257 } ]
```

ç®—æ³•å·²ç»ç”Ÿæ•ˆäº†. ä¸è¿‡è¿™ä¸ª rank å…¶å®è¿˜æ˜¯æœ‰ç‚¹é—®é¢˜, å› ä¸ºå®ƒä»¬å®åœ¨å¤ªå°, å¯¹äºåŸºäº IEEE æµ®ç‚¹æ•°æ ‡å‡†å®ç°æµ®ç‚¹æ•°çš„è¯­è¨€æ¥è¯´, è¿™äº›æ•°å­—å¾€å¾€éƒ½ä¸æ˜¯ç²¾ç¡®çš„, è¿™æ ·å°±ä¼šå¯¼è‡´å¶å°”æ’åºä¸å‡†. å¯ä»¥é€šè¿‡**æ”¾å¤§**æ¥è§£å†³è¿™ä¸ªé—®é¢˜.



# æå‡æœç´¢ä½“éªŒ

## åç«¯è°ƒæ•´

å¦‚æœæ¯æ¬¡è¿”å›åªä¼šè¿”å›ä¸€å † URL çš„è¯, ä½“éªŒä¼šéå¸¸å·®. å¯ä»¥é€šè¿‡è®©æœåŠ¡å™¨åœ¨å‘é€ URL ä¹‹å‰, å» fetch è¿™äº› URL çš„å†…å®¹, å¹¶è¿”å›ç‰¹å®šåœ°æ–¹çš„æ–‡æœ¬ä½œä¸ºè¿”å›çš„é¢„è§ˆå†…å®¹.

ä¸ºä»€ä¹ˆä¸èƒ½è®©å‰ç«¯å» fetch å‘¢? è¿™æ˜¯å› ä¸ºæµè§ˆå™¨å­˜åœ¨**è·¨åŸŸæœºåˆ¶**[^3], è¿™ç§é€šè¿‡ ajax è¯·æ±‚ HTML çš„æ–¹å¼, è‚¯å®šæ˜¯ä¸ä¼šè¢«å…è®¸çš„. æ‰€ä»¥åªèƒ½å°†æ§åˆ¶è½¬ç§»åˆ°åç«¯. ç»ˆäº, cherrio è¦é‡æ–°å‘æŒ¥ä½œç”¨äº†. 

ä¸ºäº†ä¿è¯å“åº”çš„è¿”å›é€Ÿåº¦, ä¸å¯èƒ½å» fetch æ‰€æœ‰çš„ URL. æ‰€ä»¥æœ¬æ–‡çš„ç­–ç•¥æ˜¯æœ€å¤šåªé¢„å¤„ç†äº”ä¸ª URL. åŒæ—¶ä¸ºäº†å°½å¯èƒ½éƒ½å‡å°‘ fetch çš„æ¬¡æ•°, éœ€è¦å¯¹ä¹‹å‰è¯·æ±‚è¿‡çš„ URL åšä¸€ä¸ªç¼“å­˜. æœ€å, ç½‘ç»œæ¡ä»¶å¾ˆå¤æ‚, ä¸å¯èƒ½èƒ½å¤Ÿä¿è¯ä¸å‘ç”Ÿé”™è¯¯, æ‰€ä»¥è¿˜éœ€è¦å¤„ç†é”™è¯¯æƒ…å†µä¸‹çš„è¿”å›æ•°æ®æ ¼å¼, é˜²æ­¢å‰ç«¯å‚»ä¹ä¹çš„ç­‰å¾…ç€ä¸€ä¸ªä¸å¯èƒ½åˆ°æ¥æˆ–è€…æ ¼å¼ä¸ç¬¦åˆé¢„æœŸçš„æ•°æ®. ä¸‹é¢æ˜¯åç«¯ä»£ç .

```js
  try {
    const texts = links.slice(0, 5).map(link => {
      if (!link.startsWith('http')) {
        link = 'https://stackoverflow.com' + link;
      }
      return (
        cache.get(link) ||
        axios.get(link, { responseType: 'text' }).then(prop('data'))
      );
    });

    return texts.reduce(async (preload, text, i) => {
      const $ = cheerio.load(await text);
      const html = $('selector1').html();
      const tags = $('.selector2')
        .text()
        .trim()
        .split(' ');
      cache.has(links[i]) || cache.set(links[i], text);
      return (await preload).concat({ html, tags });
    }, []);
  } catch (err) {
    console.log(err);
    return Array(5).fill(
      { html: 'è¯»å–ç½‘ç«™å¤±è´¥, å†è¯•ä¸€æ¬¡å§ğŸ‘€', tags: ['network'] }
    );
}
```

åˆšå¼€å§‹çš„ if è¯­å¥è¿˜æ˜¯ä¸ºäº†é˜²æ­¢æœ‰éƒ¨åˆ† URL æ²¡æœ‰å¤„ç†å¦¥å–„, é‡‡ç”¨çš„æ˜¯ç›¸å¯¹è·¯å¾„çš„æ–¹å¼. å¦‚æœè¿™æ ·çš„è¯, å°±æ”¹ä¸ºç»å¯¹è·¯å¾„. `cache.get(link)` æ•´ä¸ªè¯­è¨€çš„ä½œç”¨å°±æ˜¯æ£€æŸ¥ç¼“å­˜, å¦‚æœ URL è¢«ç¼“å­˜è¿‡çš„è¯, å°±ç›´æ¥è¿”å›ç»“æœ, å¦åˆ™æ‰å‘é€è¯·æ±‚.

è€Œæ¥å£è¿”å›çš„ä»£ç ä¹Ÿè°ƒæ•´æˆ

```js
ctx.body = {
  urls: result,
  preload: await reload(result),
};
```

å¿½ç•¥è¯­è¨€çš„ç»†èŠ‚çš„è¯, è¿”å›çš„å°±æ˜¯ 

```json
resposne = {
  urls: ['a'],
  preload: [
    {html: 'â€¦', tags: []},
  ]
}
```



## å‰ç«¯æ”¹è¿›

### æœç´¢æ¡†

ç¬¬ä¸€ä¸ªéœ€è¦æ”¹è¿›çš„åœ°æ–¹æ˜¯æœç´¢æ¡†çš„ UI. æ˜¾ç„¶ä½œä¸ºæ•´ä¸ªé¡µé¢çš„å”¯ä¸€åŠŸèƒ½, æ”¾åœ¨å·¦ä¸Šè§’å¹¶ä¸èƒ½å½°æ˜¾å®ƒçš„ç‹¬ç‰¹æ€§. æ‰€ä»¥éœ€è¦è°ƒæ•´åˆ°ä¸­é—´æ¥. åœ¨å‡ å¹´å‰, ç«–ç›´å±…ä¸­åœ¨æµè§ˆå™¨å¾ˆéš¾å®ç°, å¥½åœ¨ç°åœ¨æœ‰äº† `flex`, å®ç°è¿™ä¸ªæ•ˆæœåªéœ€è¦å‡ è¡Œä»£ç :

```css
.search-bar {
  display: flex;
  justify-conetent: center;
  align-items: center;
}
```

å¦å¤–, ä¹‹å‰çš„æœç´¢æŒ‰é’®æ˜¯è“è‰²çš„, æ„Ÿè§‰å¹¶ä¸æ˜¯å’Œå’Œè°, å¯ä»¥æ”¹æˆäº†æµ…ç°è‰². æ–‡å­—ä½¿ç”¨ Emoji ä¼šæ›´å¯çˆ±ä¸€äº›.

æœ€åçš„æ•ˆæœæ˜¯:

![new-search](/Users/yk/Documents/paper/pages/image-20180429015051286.png)

æ¥ä¸‹æ¥é’ˆå¯¹æ¥å£çš„æ•°æ®éœ€è¦ä½œå‡ºåˆ¤æ–­. `urls` è¿”å›çš„æ˜¯æ‰€æœ‰æœç´¢ç»“æœçš„ URL, è€Œ `preload` è¿”å›çš„æ˜¯å‰äº”ä¸ªç½‘é¡µçš„ä¸€äº›å…ƒæ•°æ®. é’ˆå¯¹è¿™äº› urls, å’Œä¹‹å‰çš„å¤„ç†æ–¹å¼ç›¸ä¼¼, åªä¸è¿‡ä¹‹å‰çš„ç›´æ¥å°† URL æ˜¾ç¤ºå‡ºæ¥çš„æ–¹å¼æœªå…è¿‡äºç›´æ¥, å¯ä»¥å°† a æ ‡ç­¾çš„å†…å®¹æ”¹ä¸ºæ›´åŠ æœ‰æ„ä¹‰çš„ Title, åƒä¸‹é¢çš„ä¸€æ ·

![æ²¡æœ‰é¢„è§ˆçš„æœç´¢ç»“æœ](/Users/yk/Documents/paper/pages/image-20180429104405524.png)

ç›¸æ¯”ä¹‹å‰çš„å·²ç»çš„ UI å·²ç»æœ‰å¾ˆå¤§çš„è¿›æ­¥äº†. æ¥ç€è°ƒæ•´éœ€è¦é¢„è§ˆçš„ UI. æ³¨æ„åˆ°åç«¯ç›´æ¥è¿”å›çš„æ˜¯ HTML çš„æ–‡ä»¶ç»“æœ, ä¹Ÿå°±æ˜¯åŒ…æ‹¬äº†å„ç§æ ‡ç­¾çš„æ–‡æœ¬. åœ¨å‰ç«¯åˆ™éœ€è¦é€šè¿‡ `innerHTML` æ¥è§£æ. åœ¨ä¸€èˆ¬æƒ…å†µä¸‹, ç›´æ¥ä½¿ç”¨ innerHTML å¾ˆå®¹æ˜“å—åˆ°æ”»å‡», ä½†æ˜¯å› ä¸ºè¿™ä¸ªæ•°æ®æ˜¯ç”± Stack Overflow å‡†å¤‡çš„, æ‰€ä»¥ä¸éœ€è¦æ‹…å¿ƒå®‰å…¨æ€§. æˆªå–ä»£ç çš„éƒ¨åˆ†ç‰‡æ®µ, åƒä¸‹é¢è¿™æ ·. 

```js
    {html && (
      <div className="card-content">
        <div
          className="content has-text-left"
          dangerouslySetInnerHTML={{
            __html: html,
          }}
        />
      </div>
    )}
```



å¯¹äº `tags` , å®ƒæ˜¯ä¸€ä¸ªæ•°ç»„, å¯ä»¥é€šè¿‡ `map` ç”Ÿæˆæ•´ä¸ª UI. ä½†æ˜¯æ¯ä¸€ä¸ª tag, å•å•åªæ˜¯æš‚æ—¶çš„è¯æ•ˆæœä¸å¤§, å°†å®ƒè°ƒæ•´ä¸º a æ ‡ç­¾çš„. æŒ‡å‘ Stack Overflow ä¸Šçš„ç‰¹å®šä¸“åŒº, æ‰æ›´æœ‰æ„ä¹‰.

è°ƒæ•´è¿™ä¸€å—çš„ä»£ç ä¸º

```js
<div className="tags">
  {tags.map(tag => (
    <a
      target="_blank"
      className="tag is-info"
      key={tag}
      href={parseTagToUrl(tag)}
    >
      {tag}
    </a>
  ))}
</div>;
```

æœ€åçš„æ˜¾ç¤ºæ•ˆæœ.

![é¢„è§ˆ](/Users/yk/Documents/paper/pages/image-20180429105955337.png)



[^3]: https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS
[^2]: https://zh.wikipedia.org/wiki/ç‰›é¡¿æ³•
[^1]: http://www.w3.org/TR/html5/



# å‚è€ƒæ–‡çŒ®

W3Câ€”â€”CSS Selector Level 3[S]

IEEE 754-2008â€”â€”Floating Point Standard[S]

Alexander Zlatkov.	How JavaScript Works: Inside the Networking Layer + How to Optimize Its Performance and Security[DB/OL] https://blog.sessionstack.com/how-javascript-works-inside-the-networking-layer-how-to-optimize-its-performance-and-security-f71b7414d34c

Ilya Grigorik.	Constructing the Object Model https://developers.google.cn/web/fundamentals/performance/critical-rendering-path/constructing-the-object-model

Ilya Grigorik.	Render-tree Construction, Layout and Paint[DB/OL] https://developers.google.cn/web/fundamentals/performance/critical-rendering-path/render-tree-construction

Ilya Grigorik.	Measuring the Critical Rendering Path[DB/OL] https://developers.google.cn/web/fundamentals/performance/critical-rendering-path/measure-crp

Ilya Grigorik, Suram.	Introduction to HTTP/2[DB/OL] https://developers.google.cn/web/fundamentals/performance/http2/

dhurlburtusa, AndreiIgna, CheungJ.	Cross-Origin Resource Sharing (CORS)[DB/OL] https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS

maththewmuller, juglinmike.	Cheerio[DB/OL] https://github.com/matthewmueller

Wikipedia.	 Stopwords[DB/OL] https://en.wikipedia.org/wiki/Stop_words

dangra, redapple, kmike.	Scrapy[DB/OL] https://doc.scrapy.org/en/latest/intro/tutorial.html





# è‡´è°¢

æœ¬è®ºæ–‡çš„å‡ºç°ä¾é äº† Google, æ²¡æœ‰å®ƒå¼ºå¤§çš„æœç´¢åŠŸèƒ½, å¾ˆå¤šä¸œè¥¿éƒ½éš¾æœ‰è¿›å±•. çœŸçš„æ²¡æ³•ç›¸ä¿¡æ²¡äº† Google ç¨‹åºå‘˜ä¼šæ€ä¹ˆæ ·. åŒæ—¶éœ€è¦æ„Ÿè°¢ Mozilla, å®ƒä»¬é™¤äº†ä¸ºä¸–ç•Œå¸¦æ¥äº† Firefox æµè§ˆå™¨, è¿˜å¸¦æ¥äº† Mozilla å¼€å‘è€…ç¤¾åŒº. åœ¨è¿™é‡Œå¯ä»¥å­¦åˆ°æ‰€æœ‰æœ‰å…³çš„å‰ç«¯åŸºç¡€æŠ€æœ¯. æ„Ÿè°¢ Medium, è¿™æ˜¯ä¸€ä¸ªç¥å¥‡çš„åšå®¢ç½‘ç«™, é‡Œé¢çš„åšå®¢è´¨é‡æé«˜, å¤§é‡æå‡ä»£ç è´¨é‡çš„å»ºè®®å’Œçµæ„Ÿéƒ½æ¥æºäºå®ƒ.

æ„Ÿè°¢ Facebook, å¦‚æœä¸æ˜¯å®ƒä»¬æ¨å‡ºäº† React, ç°åœ¨çš„å‰ç«¯å¼€å‘è¿˜è¦åŸºäº jQuery çš„è¯, æˆ‘å¯èƒ½æ ¹æœ¬å°±ä¸ä¼šæˆä¸ºå‰ç«¯å·¥ç¨‹å¸ˆ. 

æ„Ÿè°¢å¼€æºç¤¾åŒº, ç‰¹åˆ«æ˜¯ Github.  æ²¡æœ‰å¼€æºç¤¾åŒºçš„æ”¯æŒ, React å¯èƒ½ä¹Ÿä»…ä»…åªæ˜¯ Facebook å†…éƒ¨çš„ä¸€ä¸ªå·¥å…·, ä¸å¯èƒ½æˆä¸ºä¸–ç•Œä¸Šæœ€å—æ¬¢è¿çš„å·¥å…·. åŒæ—¶, ä»£ç ä¸­ç”¨åˆ°çš„ axios, ramda, cherrio, scrapy, nodejs éƒ½æ˜¯åœ¨ Github ä¸­å¼€æºçš„é¡¹ç›®. ä¸æ•¢ç›¸ä¿¡å¦‚æœå®ƒä»¬æ˜¯é—­æºçš„, æœç´¢å¼•æ“çš„å¼€å‘ä¼šæœ‰å¤šä¹ˆå¤æ‚. 



æœ€å, æ„Ÿè°¢ Apple å…¬å¸, å¾ˆéš¾æƒ³è±¡åœ¨ä½¿ç”¨äº† Mac å, ä¹‹å‰æ€ä¹ˆèƒ½å—å¾—äº† window ç”µè„‘å¼€å‘.
æ„Ÿè°¢å­¦æ ¡, æ„Ÿè°¢å¯¼å¸ˆ, å¦‚æœä¸æ˜¯ä½ ä»¬é‚£ä¹ˆä¸¥æ ¼, è¿™ç¯‡è®ºæ–‡ä¹Ÿä¸ä¼šé‚£ä¹ˆå¿«çš„å®Œæˆ.
è¿˜æœ‰æˆ‘çš„å®¶äºº, åœ¨å¤§å­¦çš„æ—¶å€™æ²¡æœ‰å¯¹æˆ‘æœ‰å¤ªå¤šçš„é™åˆ¶, ä»¥åŠå¯¹æˆ‘çš„ä¿¡ä»», è®©æˆ‘åœ¨èƒ½å¤Ÿè‡ªç”±é€‰æ‹©è‡ªå·±çš„æœªæ¥.